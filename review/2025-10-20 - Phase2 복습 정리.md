# Java í…ŒìŠ¤íŠ¸ ì½”ë“œ í•™ìŠµ - Day 2 ë³µìŠµ ğŸ“š

> **ì‘ì„±ì¼**: 2025-10-20
> **í•™ìŠµ ë‹¨ê³„**: Phase 2 - ì§€ì¸ í…ŒìŠ¤íŠ¸ ì¸í”„ë¼ ì´í•´ ë° ì‹¬í™”
> **í•™ìŠµ ì‹œê°„**: ì•½ 2ì‹œê°„
> **ì£¼ìš” ì£¼ì œ**: JpaBeanInitializer, TestTransactionSupport, AutoMockExtension, Spring ì´ˆê¸°í™”, Introspector, CompletableFuture

---

## ğŸ“‘ ëª©ì°¨

1. [ì˜¤ëŠ˜ í•™ìŠµí•œ ë‚´ìš© ìš”ì•½](#ì˜¤ëŠ˜-í•™ìŠµí•œ-ë‚´ìš©-ìš”ì•½)
2. [JpaBeanInitializer ì›ë¦¬](#1-jpabeannitializer-ì›ë¦¬)
3. [TestTransactionSupport í™œìš©](#2-testtransactionsupport-í™œìš©)
4. [AutoMockExtension ì‹¬ì¸µ ë¶„ì„](#3-automockextension-ì‹¬ì¸µ-ë¶„ì„)
5. [Spring í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì•„í‚¤í…ì²˜](#4-spring-í…ŒìŠ¤íŠ¸-ì´ˆê¸°í™”-ì•„í‚¤í…ì²˜)
6. [Introspector ì›ë¦¬](#5-introspector-ì›ë¦¬)
7. [Futureì™€ CompletableFuture](#6-futureì™€-completablefuture)
8. [ì „ì²´ ìš”ì•½ ë° ë‹¤ìŒ í•™ìŠµ](#ì „ì²´-ìš”ì•½-ë°-ë‹¤ìŒ-í•™ìŠµ)

---

## ì˜¤ëŠ˜ í•™ìŠµí•œ ë‚´ìš© ìš”ì•½

### Phase 2 ëª©í‘œ
ì§€ì¸ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¸í”„ë¼ 3ê°€ì§€ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ì´í•´:
1. **JpaBeanInitializer**: `@DataJpaTest`ì—ì„œ Repository ìë™ ë“±ë¡
2. **TestTransactionSupport**: ë™ì‹œì„± í…ŒìŠ¤íŠ¸ìš© íŠ¸ëœì­ì…˜ ë¶„ë¦¬
3. **AutoMockExtension**: `PER_CLASS`ì—ì„œ Mock ìƒíƒœ ê´€ë¦¬

### ì¶”ê°€ ì‹¬í™” í•™ìŠµ
- Spring ApplicationContext ì´ˆê¸°í™” ê³¼ì • (JVM â†’ Context â†’ Beans)
- Introspectorì™€ JavaBeans ëª…ëª… ê·œì¹™
- CompletableFutureë¥¼ í™œìš©í•œ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ íŒ¨í„´

### í•™ìŠµ íë¦„

```mermaid
graph TB
    A[Day 1: Phase 1<br/>ê¸°ë³¸ ê°œë…] --> B[Day 2: Phase 2<br/>ì¸í”„ë¼ ì´í•´]

    subgraph "Phase 1 ë³µìŠµ"
        A1[JUnit 5 ìƒëª…ì£¼ê¸°]
        A2[Mockito ê¸°ë³¸]
        A3[Fixture Monkey]
    end

    subgraph "Phase 2 í•™ìŠµ"
        B1[JpaBeanInitializer<br/>Spring ì´ˆê¸°í™”]
        B2[TestTransactionSupport<br/>íŠ¸ëœì­ì…˜ ë¶„ë¦¬]
        B3[AutoMockExtension<br/>Mock ê´€ë¦¬]
        B4[CompletableFuture<br/>ë™ì‹œì„± íŒ¨í„´]
    end

    A --> A1
    A --> A2
    A --> A3

    B --> B1
    B --> B2
    B --> B3
    B --> B4

    style B fill:#4dabf7
```

---

## 1. JpaBeanInitializer ì›ë¦¬

### ë¬¸ì œ ìƒí™©

```mermaid
graph TB
    subgraph "ì¼ë°˜ SpringBootTest"
        A1[SpringBootTest] --> B1[ì „ì²´ ì»¨í…ìŠ¤íŠ¸]
        B1 --> C1[ComponentScan í™œì„±]
        C1 --> D1[Repository ìë™ ë“±ë¡ âœ…]
    end

    subgraph "DataJpaTest"
        A2[DataJpaTest] --> B2[JPAë§Œ ë¡œë“œ]
        B2 --> C2[ComponentScan ë¹„í™œì„±]
        C2 --> D2[Repository ìë™ ë“±ë¡ âŒ]
    end

    style D1 fill:#51cf66
    style D2 fill:#ff6b6b
```

**ë¬¸ì œ**: `@DataJpaTest`ëŠ” ì„±ëŠ¥ì„ ìœ„í•´ JPA ê´€ë ¨ ì»´í¬ë„ŒíŠ¸ë§Œ ë¡œë“œí•˜ë¯€ë¡œ `@Repository`ê°€ ìë™ìœ¼ë¡œ ìŠ¤ìº”ë˜ì§€ ì•ŠìŒ!

### í•´ê²°ì±…: ApplicationContextInitializer

```java
public class JpaBeanInitializer implements ApplicationContextInitializer<ConfigurableApplicationContext> {

    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        // 1. BeanFactory ê°€ì ¸ì˜¤ê¸°
        var beanFactory = (BeanDefinitionRegistry) applicationContext.getBeanFactory();

        // 2. Repository ìŠ¤ìºë„ˆ ìƒì„±
        var beanScanner = new ClassPathScanningCandidateComponentProvider(false);
        beanScanner.addIncludeFilter(new AnnotationTypeFilter(Repository.class));

        // 3. com.concurrency íŒ¨í‚¤ì§€ì—ì„œ @Repository ì°¾ê¸°
        var repositoryBeans = beanScanner.findCandidateComponents("com.concurrency");

        // 4. ì°¾ì€ Repositoryë“¤ì„ BeanDefinitionìœ¼ë¡œ ë“±ë¡
        for (var definition : repositoryBeans) {
            var beanName = Introspector.decapitalize(definition.getBeanClassName());
            beanFactory.registerBeanDefinition(beanName, definition);
        }
    }
}
```

### ë™ì‘ íë¦„

```mermaid
sequenceDiagram
    participant Test as í…ŒìŠ¤íŠ¸ ì‹œì‘
    participant Spring as SpringTestContext
    participant Initializer as JpaBeanInitializer
    participant Scanner as ClassPathScanner
    participant Registry as BeanDefinitionRegistry

    Test->>Spring: DataJpaTest ì‹¤í–‰
    Spring->>Spring: ApplicationContext ìƒì„±

    Note over Spring,Registry: Phase 1: Initializer ì‹¤í–‰ â­

    Spring->>Initializer: initialize(context)
    Initializer->>Scanner: findCandidateComponents("com.concurrency")

    Scanner->>Scanner: com.concurrency íŒ¨í‚¤ì§€ ìŠ¤ìº”
    Scanner-->>Initializer: [ProductRepository, UserRepository, ...]

    Note over Initializer: ê° Repositoryì— ëŒ€í•´

    Initializer->>Initializer: Introspector.decapitalize<br/>(beanName ìƒì„±)
    Initializer->>Registry: registerBeanDefinition<br/>("productRepository", definition)

    Note over Spring,Registry: Phase 2: Bean ìƒì„±

    Spring->>Registry: ë“±ë¡ëœ BeanDefinitionìœ¼ë¡œ Bean ìƒì„±
    Registry-->>Spring: Repository ì¸ìŠ¤í„´ìŠ¤ë“¤

    Spring-->>Test: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ
```

### í•µì‹¬ ê°œë…

#### ApplicationContextInitializerë€?

```mermaid
graph LR
    A[ApplicationContext ìƒì„±] --> B[Initializer ì‹¤í–‰]
    B --> C[BeanDefinition ë“±ë¡]
    C --> D[Context.refresh]
    D --> E[Bean ì¸ìŠ¤í„´ìŠ¤ ìƒì„±]

    style B fill:#ff6b6b
    style C fill:#4dabf7
```

- **ì—­í• **: ApplicationContextê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ê¸° **ì „**ì— ì‹¤í–‰
- **íƒ€ì´ë°**: BeanDefinition ë“±ë¡ ë‹¨ê³„ (Bean ìƒì„± ì´ì „)
- **ìš©ë„**: ë™ì ìœ¼ë¡œ Beanì„ ë“±ë¡í•˜ê±°ë‚˜ Context ì„¤ì • ë³€ê²½

#### BeanDefinition vs Bean Instance

| í•­ëª© | BeanDefinition | Bean Instance |
|-----|---------------|---------------|
| íƒ€ì´ë° | Context ì´ˆê¸°í™” ì „ | Context.refresh ì‹œ |
| ë‚´ìš© | "ì–´ë–»ê²Œ ë§Œë“¤ê¹Œ" ì„¤ê³„ë„ | ì‹¤ì œ ìƒì„±ëœ ê°ì²´ |
| ì €ì¥ ìœ„ì¹˜ | BeanDefinitionRegistry | BeanFactory |
| ì˜ˆì‹œ | í´ë˜ìŠ¤ëª…, scope, lazy ë“± | Heap ë©”ëª¨ë¦¬ì˜ ê°ì²´ |

```java
// BeanDefinition: ì„¤ê³„ë„
BeanDefinition def = new GenericBeanDefinition();
def.setBeanClassName("com.concurrency.shop.domain.product.ProductRepository");
def.setScope("singleton");

// Bean Instance: ì‹¤ì œ ê°ì²´ (ë‚˜ì¤‘ì— ìƒì„±ë¨)
ProductRepository instance = new ProductRepository(...);
```

### ì‹¤ìŠµ: ìƒˆ Repository ì¶”ê°€ ì‹œ ìë™ ì¸ì‹

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:
1. ìƒˆë¡œìš´ `OrderRepository` ìƒì„±
2. `@Repository` ì• ë…¸í…Œì´ì…˜ë§Œ ì¶”ê°€
3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ Bean ë“±ë¡ í™•ì¸

```java
// 1. OrderRepository ìƒì„±
@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
}

// 2. í…ŒìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥!
@DataJpaTest
@ContextConfiguration(initializers = JpaBeanInitializer.class)
class OrderServiceTest extends AbstractJpaTest {

    @Autowired
    private OrderRepository orderRepository;  // âœ… ìë™ ì£¼ì…!

    @Test
    void test() {
        assertThat(orderRepository).isNotNull();
    }
}
```

---

## 2. TestTransactionSupport í™œìš©

### ë¬¸ì œ ìƒí™©: ë™ì‹œì„± í…ŒìŠ¤íŠ¸ì—ì„œ íŠ¸ëœì­ì…˜ ì¶©ëŒ

```mermaid
sequenceDiagram
    participant Test as í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ
    participant Thread1 as Worker Thread 1
    participant Thread2 as Worker Thread 2
    participant DB as MySQL

    Note over Test,DB: ê¸°ë³¸ Transactional - ë¬¸ì œ ë°œìƒ!

    Test->>Test: Transactional ì‹œì‘<br/>(í…ŒìŠ¤íŠ¸ ì „ì²´ë¥¼ ê°ìŒˆ)
    Test->>DB: User ì €ì¥ (ì•„ì§ ì»¤ë°‹ ì•ˆë¨)

    Test->>Thread1: ì‘ì—… ì‹¤í–‰
    Thread1->>DB: SELECT User
    Note over DB: âŒ ë³´ì´ì§€ ì•ŠìŒ!<br/>íŠ¸ëœì­ì…˜ ë¶„ë¦¬ë¨

    Test->>Thread2: ì‘ì—… ì‹¤í–‰
    Thread2->>DB: SELECT User
    Note over DB: âŒ ë³´ì´ì§€ ì•ŠìŒ!
```

**ë¬¸ì œ**: í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì˜ `@Transactional`ê³¼ Worker Threadì˜ íŠ¸ëœì­ì…˜ì´ ë¶„ë¦¬ë˜ì–´ ìˆì–´ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ìŒ!

### í•´ê²°ì±…: REQUIRES_NEW

```java
@TestComponent
public class TestTransactionSupport {

    // ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ì¦‰ì‹œ ì»¤ë°‹
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void executeWithNewTx(Runnable runnable) {
        runnable.run();
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public <T> T executeWithNewTx(Callable<T> callable) {
        try {
            return callable.call();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}
```

### Propagation.REQUIRES_NEW ë™ì‘ ì›ë¦¬

```mermaid
graph TB
    subgraph "ê¸°ë³¸ Transactional"
        A1[Test Method Tx] --> B1[User ì €ì¥]
        B1 --> C1[ë©”ì„œë“œ ëë‚  ë•Œ<br/>ì»¤ë°‹]

        Note1[Worker Threadê°€<br/>ë³¼ ìˆ˜ ì—†ìŒ âŒ]
    end

    subgraph "REQUIRES_NEW"
        A2[Test Method Tx] --> B2[executeWithNewTx í˜¸ì¶œ]
        B2 --> C2[ìƒˆ Tx ì‹œì‘]
        C2 --> D2[User ì €ì¥]
        D2 --> E2[ì¦‰ì‹œ ì»¤ë°‹ âœ…]
        E2 --> F2[Test Method Txë¡œ ë³µê·€]

        Note2[Worker Threadê°€<br/>ë³¼ ìˆ˜ ìˆìŒ âœ…]
    end

    style C1 fill:#ff6b6b
    style E2 fill:#51cf66
```

### íŠ¸ëœì­ì…˜ ì „íŒŒ ë ˆë²¨ ë¹„êµ

| Propagation | ì„¤ëª… | ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ |
|------------|------|-------------|
| REQUIRED (ê¸°ë³¸) | ê¸°ì¡´ Tx ìˆìœ¼ë©´ ì°¸ì—¬, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± | ì¼ë°˜ì ì¸ ê²½ìš° |
| REQUIRES_NEW | í•­ìƒ ìƒˆ Tx ìƒì„±, ê¸°ì¡´ TxëŠ” ì¼ì‹œ ì¤‘ë‹¨ | ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ â­ |
| MANDATORY | ë°˜ë“œì‹œ ê¸°ì¡´ Tx í•„ìš” | ë…ë¦½ ì‹¤í–‰ ë°©ì§€ |
| NEVER | Tx ì•ˆì—ì„œ ì‹¤í–‰ë˜ë©´ ì˜ˆì™¸ | Tx ì—†ì´ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ì‘ì—… |

### ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

```java
@DisplayName("í¬ì¸íŠ¸ ì„œë¹„ìŠ¤ ë™ì‹œì„± í…ŒìŠ¤íŠ¸")
class PointServiceConcurrencyTest extends AbstractConcurrencyTest {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PointServiceV2 pointServiceV2;

    @Test
    void use_point_concurrently() {
        // given: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ (ìƒˆ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¦‰ì‹œ ì»¤ë°‹!)
        var user = fixture.giveMeBuilder(User.class)
                .setNull("id")
                .set("pointBalance", 10_000L)
                .sample();

        testTransactionSupport.executeWithNewTx(() -> userRepository.save(user));
        // âœ… ì—¬ê¸°ì„œ ì»¤ë°‹ë¨! Worker Threadë“¤ì´ ë³¼ ìˆ˜ ìˆìŒ

        // when: 10ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— í¬ì¸íŠ¸ ì‚¬ìš©
        final var executor = Executors.newFixedThreadPool(10);

        var futures = IntStream.range(0, 10)
                .mapToObj(it -> CompletableFuture.runAsync(() -> {
                    pointServiceV2.usePoints(user.getId(), 1000L, 1L);
                }, executor))
                .toArray(CompletableFuture[]::new);

        CompletableFuture.allOf(futures).join();
        executor.shutdown();

        // then
        var findUser = userRepository.findById(user.getId()).orElseThrow();
        assertThat(findUser.getPointBalance()).isEqualTo(0L);
    }
}
```

### ë™ì‘ íë¦„ ìƒì„¸

```mermaid
sequenceDiagram
    participant Test as í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ
    participant Support as TestTransactionSupport
    participant DB as MySQL
    participant Thread1 as Worker Thread

    Note over Test,Thread1: 1ë‹¨ê³„: ë°ì´í„° ì¤€ë¹„ (REQUIRES_NEW)

    Test->>Support: executeWithNewTx(() -> save(user))
    Support->>DB: ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘
    Support->>DB: INSERT User (balance: 10000)
    Support->>DB: COMMIT âœ…
    Support-->>Test: ì™„ë£Œ

    Note over Test,Thread1: 2ë‹¨ê³„: ë™ì‹œì„± í…ŒìŠ¤íŠ¸

    Test->>Thread1: runAsync(usePoints)
    Thread1->>DB: ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘
    Thread1->>DB: SELECT ... FOR UPDATE
    Note over DB: âœ… User ì¡°íšŒ ì„±ê³µ!<br/>ì´ë¯¸ ì»¤ë°‹ë˜ì–´ ìˆìŒ
    Thread1->>DB: UPDATE balance
    Thread1->>DB: COMMIT
```

### í•µì‹¬ í¬ì¸íŠ¸

1. **ì¼ë°˜ `@Transactional`**: ë©”ì„œë“œ ì¢…ë£Œ ì‹œ ì»¤ë°‹
2. **`REQUIRES_NEW`**: ì¦‰ì‹œ ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘í•˜ê³  ì™„ë£Œ ì‹œ ì»¤ë°‹
3. **ë™ì‹œì„± í…ŒìŠ¤íŠ¸**: Worker Threadë“¤ì´ ë°ì´í„°ë¥¼ ë³´ë ¤ë©´ **ë¯¸ë¦¬ ì»¤ë°‹** í•„ìš”
4. **ì‚¬ìš©ì²˜**: `AbstractConcurrencyTest`ì—ì„œ `testTransactionSupport` í•„ë“œë¡œ ì œê³µ

---

## 3. AutoMockExtension ì‹¬ì¸µ ë¶„ì„

### ë¬¸ì œ ìƒí™©

```mermaid
graph TB
    subgraph "ë©”ëª¨ë¦¬ ìƒíƒœ"
        A[TestClass ì¸ìŠ¤í„´ìŠ¤<br/>0x1234] --> B[userRepository<br/>Mock ê°ì²´ 0x5678]
    end

    subgraph "test1 ì‹¤í–‰"
        C[given í˜¸ì¶œ] --> D[Mock ë‚´ë¶€ì—<br/>stub ë°ì´í„° ì €ì¥]
        D --> E[0x5678 ì£¼ì†Œì˜ Mockì—<br/>findById 1L â†’ User A]
    end

    subgraph "test2 ì‹¤í–‰"
        F[ìƒˆë¡œìš´ given ì—†ìŒ] --> G[Mock ë‚´ë¶€<br/>ê¸°ì¡´ stub ê·¸ëŒ€ë¡œ]
        G --> H[0x5678 ì£¼ì†Œì˜ Mockì—<br/>ì—¬ì „íˆ findById 1L â†’ User A]
    end

    E --> F

    style D fill:#ff6b6b
    style H fill:#ff6b6b
```

**ë¬¸ì œ**: `@TestInstance(PER_CLASS)`ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ê°€ 1ê°œë§Œ ìƒì„±ë˜ë¯€ë¡œ, Mock ê°ì²´ë„ 1ê°œë§Œ ì¡´ì¬. ì´ì „ í…ŒìŠ¤íŠ¸ì˜ stub ë°ì´í„°ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì¤Œ!

### ì½”ë“œë¡œ ë³´ëŠ” ë¬¸ì œ

```java
// TestInstance PER_CLASS - ì¸ìŠ¤í„´ìŠ¤ 1ê°œë§Œ!
@TestInstance(Lifecycle.PER_CLASS)
class Test {
    // Mock - userRepository ë©”ëª¨ë¦¬ ì£¼ì†Œ: 0x5678
    @Mock
    UserRepository userRepository;

    // Test 1
    @Test
    void test1() {
        // Mock ë‚´ë¶€ì— ë°ì´í„° ì €ì¥
        given(userRepository.findById(1L))
            .willReturn(Optional.of(new User("Alice")));

        // Mock ë‚´ë¶€ ìƒíƒœ:
        // { findById: { 1L: User("Alice") } }
    }

    // Test 2
    @Test
    void test2() {
        // âŒ Mockì´ ì´ˆê¸°í™” ì•ˆ ë¨!
        // Mock ë‚´ë¶€ ìƒíƒœ ê·¸ëŒ€ë¡œ:
        // { findById: { 1L: User("Alice") } }  ğŸ‘ˆ test1 ì˜í–¥

        var result = userRepository.findById(1L);
        // âŒ Optional[User("Alice")] ë¦¬í„´ë¨!
    }
}
```

### AutoMockExtension í•´ê²° ë°©ë²•

```java
public class AutoMockExtension implements BeforeAllCallback, AfterAllCallback, AfterEachCallback {

    private final static ExtensionContext.Namespace MOCKITO = create("org.mockito");
    private final static String SESSION = "session", MOCKS = "mocks";

    @Override
    public void beforeAll(ExtensionContext context) {
        var testInstance = context.getRequiredTestInstance();

        // 1. MockitoSession ì‹œì‘
        MockitoSession session = Mockito.mockitoSession()
                .initMocks(testInstance)
                .startMocking();

        // 2. í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì˜ ëª¨ë“  í•„ë“œ ìŠ¤ìº”
        var mockSet = new HashSet<>();
        var fields = testInstance.getClass().getDeclaredFields();

        for (var field : fields) {
            field.setAccessible(true);
            var extractField = field.get(testInstance);

            // 3. Mockì´ë‚˜ Spyì¸ì§€ í™•ì¸
            if (Mockito.mockingDetails(extractField).isMock() ||
                Mockito.mockingDetails(extractField).isSpy()) {
                mockSet.add(extractField);  // ğŸ‘ˆ Setì— ì €ì¥!
            }
        }

        // 4. ExtensionContextì— ì €ì¥
        context.getStore(MOCKITO).put(MOCKS, mockSet);
        context.getStore(MOCKITO).put(SESSION, session);
    }

    @Override
    public void afterEach(ExtensionContext context) {
        // 5. ë§¤ í…ŒìŠ¤íŠ¸ í›„ ì €ì¥ëœ Mockë“¤ì„ reset!
        var mocks = context.getStore(MOCKITO).get(MOCKS, Set.class);
        Mockito.reset(mocks.toArray());  // âœ… ì´ˆê¸°í™”!
    }

    @Override
    public void afterAll(ExtensionContext context) {
        // 6. ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„ ì •ë¦¬
        context.getStore(MOCKITO).remove(MOCKS, Set.class);
        context.getStore(MOCKITO).remove(SESSION, MockitoSession.class)
                .finishMocking(context.getExecutionException().orElse(null));
    }
}
```

### ë™ì‘ íë¦„

```mermaid
sequenceDiagram
    participant JUnit as JUnit
    participant Extension as AutoMockExtension
    participant Mock as Mock ê°ì²´ë“¤
    participant Memory as ë©”ëª¨ë¦¬

    Note over JUnit,Memory: 1ë‹¨ê³„ BeforeAll - í´ë˜ìŠ¤ ì‹œì‘ ì‹œ 1ë²ˆ

    JUnit->>Extension: beforeAll í˜¸ì¶œ
    Extension->>Memory: í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìŠ¤ìº”
    Memory-->>Extension: userRepository, productRepository ì°¾ìŒ
    Extension->>Extension: Setì— ì €ì¥<br/>[0x5678, 0x9ABC]

    Note over JUnit,Memory: 2ë‹¨ê³„ test1 ì‹¤í–‰

    JUnit->>Mock: given í˜¸ì¶œ
    Note over Mock: stub ë°ì´í„° ì €ì¥

    JUnit->>JUnit: test1 ì¢…ë£Œ

    Note over JUnit,Memory: 3ë‹¨ê³„ AfterEach - ë§¤ í…ŒìŠ¤íŠ¸ í›„

    JUnit->>Extension: afterEach í˜¸ì¶œ
    Extension->>Mock: Mockito.reset([0x5678, 0x9ABC])
    Note over Mock: stub ë°ì´í„° ì‚­ì œ!<br/>ì´ˆê¸° ìƒíƒœë¡œ

    Note over JUnit,Memory: 4ë‹¨ê³„ test2 ì‹¤í–‰

    JUnit->>Mock: findById(1L) í˜¸ì¶œ
    Mock-->>JUnit: Optional.empty<br/>ê¹¨ë—í•œ ìƒíƒœ
```

### í•µì‹¬ ë™ì‘ 3ë‹¨ê³„

1. **BeforeAll**:
   - í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì˜ ëª¨ë“  í•„ë“œ ìŠ¤ìº”
   - Mock/Spy ê°ì²´ë“¤ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ Setì— ì €ì¥

2. **AfterEach**:
   - ì €ì¥ëœ Mockë“¤ì— ëŒ€í•´ `Mockito.reset()` í˜¸ì¶œ
   - stub ë°ì´í„° ì´ˆê¸°í™”

3. **ê²°ê³¼**:
   - ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ê¹¨ë—í•œ Mock ìƒíƒœ ìœ ì§€
   - PER_CLASSì˜ ì„±ëŠ¥ ì´ì  + í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ë³´ì¥

### ê¸°ë³¸ MockitoExtensionê³¼ ë¹„êµ

| ì‹œì  | ê¸°ë³¸ MockitoExtension | AutoMockExtension |
|-----|---------------------|------------------|
| ì¸ìŠ¤í„´ìŠ¤ ìƒì„± | ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ | í´ë˜ìŠ¤ë‹¹ 1ë²ˆ |
| Mock ì´ˆê¸°í™” | ìë™ (ìƒˆ ì¸ìŠ¤í„´ìŠ¤) | BeforeAllì—ì„œ ìˆ˜ë™ |
| Mock reset | ë¶ˆí•„ìš” (ì†Œë©¸ë¨) | AfterEachì—ì„œ ìˆ˜ë™ âœ… |
| PER_CLASS ì§€ì› | âŒ | âœ… |
| ì„±ëŠ¥ | ëŠë¦¼ (ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë¹„ìš©) | ë¹ ë¦„ |

---

## 4. Spring í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì•„í‚¤í…ì²˜

### Level 1: JVM ì‹œì‘ë¶€í„° Springê¹Œì§€

```mermaid
graph TB
    subgraph "1. JVM ì‹œì‘"
        A[java -jar app.jar] --> B[JVM í”„ë¡œì„¸ìŠ¤ ìƒì„±]
        B --> C[í´ë˜ìŠ¤ ë¡œë” ì´ˆê¸°í™”]
    end

    subgraph "2. í´ë˜ìŠ¤ ë¡œë”©"
        C --> D[Main í´ë˜ìŠ¤ ë¡œë“œ]
        D --> E[static ë¸”ë¡ ì‹¤í–‰]
        E --> F[í•„ìš”í•œ í´ë˜ìŠ¤ë“¤ ë¡œë“œ]
    end

    subgraph "3. Spring ì´ˆê¸°í™”"
        F --> G[SpringApplication.run]
        G --> H[ApplicationContext ìƒì„±]
        H --> I[ë¹ˆ ë“±ë¡ ë° ì´ˆê¸°í™”]
    end

    style A fill:#e7f5ff
    style G fill:#4dabf7
    style H fill:#ff6b6b
```

### JVM ë©”ëª¨ë¦¬ êµ¬ì¡°

```mermaid
graph TB
    subgraph "JVM ë©”ëª¨ë¦¬"
        subgraph "Heap - ê°ì²´ ì €ì¥"
            A1[Spring ApplicationContext]
            A2[Bean ê°ì²´ë“¤<br/>UserRepository<br/>ProductRepository]
            A3[í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤]
        end

        subgraph "Method Area - í´ë˜ìŠ¤ ì •ë³´"
            B1[ProductRepository.class]
            B2[UserRepository.class]
            B3[BeanDefinition ë©”íƒ€ë°ì´í„°]
        end

        subgraph "Stack - ë©”ì„œë“œ ì‹¤í–‰"
            C1[main ìŠ¤ë ˆë“œ]
            C2[test ìŠ¤ë ˆë“œ]
        end
    end

    A1 --> A2
    B1 --> A2
    C1 --> A1

    style A1 fill:#ff6b6b
    style B3 fill:#4dabf7
```

**í•µì‹¬**:
- **Heap**: ì‹¤ì œ Bean ê°ì²´ë“¤ì´ ìƒì„±ë˜ëŠ” ê³³
- **Method Area**: í´ë˜ìŠ¤ ì •ë³´ì™€ BeanDefinition ë©”íƒ€ë°ì´í„°
- **Stack**: ê° ìŠ¤ë ˆë“œì˜ ë©”ì„œë“œ ì‹¤í–‰ ì •ë³´

### Level 2: ApplicationContext ì´ˆê¸°í™” ìˆœì„œ

```mermaid
sequenceDiagram
    participant JVM
    participant Spring as SpringApplication
    participant Context as ApplicationContext
    participant Initializer as ApplicationContextInitializer
    participant Registry as BeanDefinitionRegistry
    participant Factory as BeanFactory

    Note over JVM,Factory: Phase 1: Context ì¤€ë¹„

    JVM->>Spring: run í˜¸ì¶œ
    Spring->>Context: new ApplicationContext
    Note over Context: ë¹ˆ ì»¨í…Œì´ë„ˆ ìƒì„±<br/>ë¹„ì–´ìˆìŒ

    Note over JVM,Factory: Phase 2: Initializer ì‹¤í–‰ â­

    Spring->>Context: getInitializers
    Context->>Initializer: initialize(context)
    Note over Initializer: JpaBeanInitializer.initialize<br/>ì—¬ê¸°ì„œ BeanDefinition ë“±ë¡!

    Initializer->>Context: getBeanFactory
    Context-->>Initializer: BeanDefinitionRegistry
    Initializer->>Registry: registerBeanDefinition
    Note over Registry: ProductRepository<br/>UserRepository<br/>ë“±ë¡ë¨!

    Note over JVM,Factory: Phase 3: BeanDefinition ì²˜ë¦¬

    Spring->>Context: refresh
    Context->>Registry: getBeanDefinitionNames
    Registry-->>Context: [productRepository,<br/>userRepository, ...]

    Note over JVM,Factory: Phase 4: Bean ìƒì„±

    Context->>Factory: getBean("productRepository")
    Factory->>Factory: ì¸ìŠ¤í„´ìŠ¤ ìƒì„±<br/>new ProductRepository
    Factory-->>Context: Bean ê°ì²´ ë°˜í™˜

    Note over JVM,Factory: Phase 5: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ëŠ¥

    Context->>JVM: Context ì¤€ë¹„ ì™„ë£Œ!
```

### Level 3: JpaBeanInitializerì˜ ì •í™•í•œ íƒ€ì´ë°

```mermaid
graph TB
    subgraph "Spring í…ŒìŠ¤íŠ¸ ì‹œì‘"
        A[JUnit Test ì‹¤í–‰] --> B[Spring TestContext ìƒì„±]
    end

    subgraph "ApplicationContext ìƒì„± ê³¼ì •"
        B --> C[1. prepareContext]
        C --> D[2. applyInitializers â­]
        D --> E[3. loadBeanDefinitions]
        E --> F[4. refresh]
        F --> G[5. Bean ìƒì„±]
    end

    subgraph "JpaBeanInitializer ì‹¤í–‰ ì‹œì "
        D --> H[JpaBeanInitializer.initialize]
        H --> I[ClassPathScanning]
        I --> J[Repository ì°¾ê¸°]
        J --> K[BeanDefinition ë“±ë¡]
    end

    K --> E

    style D fill:#ff6b6b
    style H fill:#4dabf7
```

### ì½”ë“œë¡œ ë³´ëŠ” ì •í™•í•œ ìˆœì„œ

```java
// Spring TestContext ë‚´ë¶€ (ê°œë…ì  ì½”ë“œ)
class TestContext {

    void prepareTestInstance() {
        // 1ë‹¨ê³„ ApplicationContext ìƒì„±
        ApplicationContext context = new AnnotationConfigApplicationContext();

        // 2ë‹¨ê³„ Initializer ì‹¤í–‰ â­ (JpaBeanInitializer ì—¬ê¸°ì„œ ì‹¤í–‰!)
        applyInitializers(context);
        // â†’ JpaBeanInitializer.initialize(context) í˜¸ì¶œë¨
        // â†’ ì´ ì‹œì ì— Repository ìŠ¤ìº”í•˜ì—¬ BeanDefinition ë“±ë¡

        // 3ë‹¨ê³„ Configuration, ComponentScan ì²˜ë¦¬
        loadBeanDefinitions(context);

        // 4ë‹¨ê³„ Context refresh (Bean ìƒì„±)
        context.refresh();
        // â†’ ì´ ì‹œì ì— ProductRepository ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

        // 5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì— ì£¼ì…
        autowireTestInstance(testInstance, context);
    }
}
```

### Level 4: BeanDefinition vs Bean ì¸ìŠ¤í„´ìŠ¤

```mermaid
graph LR
    subgraph "Phase 1: BeanDefinition - ì„¤ê³„ë„"
        A[JpaBeanInitializer] --> B[BeanDefinition ìƒì„±]
        B --> C[í´ë˜ìŠ¤ ì •ë³´:<br/>ProductRepository.class<br/>Scope: Singleton<br/>Lazy: false]
    end

    subgraph "Phase 2: Bean Instance - ì‹¤ì œ ê°ì²´"
        D[context.refresh] --> E[BeanDefinition ì½ê¸°]
        E --> F[Reflectionìœ¼ë¡œ<br/>ì¸ìŠ¤í„´ìŠ¤ ìƒì„±]
        F --> G[Heapì— ê°ì²´ ìƒì„±<br/>0x1234: ProductRepository]
    end

    C --> D

    style C fill:#e7f5ff
    style G fill:#51cf66
```

**BeanDefinition ì˜ˆì‹œ ì½”ë“œ**:

```java
// BeanDefinition: "ì´ë ‡ê²Œ ë§Œë“¤ì–´ë¼"ëŠ” ì„¤ëª…ì„œ
BeanDefinition def = new GenericBeanDefinition();
def.setBeanClassName("com.concurrency.shop.domain.product.ProductRepository");
def.setScope("singleton");
def.setLazyInit(false);

// Registryì— ë“±ë¡
registry.registerBeanDefinition("productRepository", def);

// ë‚˜ì¤‘ì— Context refresh ì‹œ:
// 1. BeanDefinition ì½ê¸°
// 2. Reflectionìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
Class<?> clazz = Class.forName("com.concurrency.shop.domain.product.ProductRepository");
Object instance = clazz.getDeclaredConstructor().newInstance();

// 3. Beanìœ¼ë¡œ ë“±ë¡
beanFactory.registerSingleton("productRepository", instance);
```

### Level 5: @DataJpaTestì˜ íŠ¹ìˆ˜ì„±

```mermaid
graph TB
    subgraph "ì¼ë°˜ SpringBootTest"
        A1[SpringBootTest] --> B1[ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ]
        B1 --> C1[ComponentScan ì‹¤í–‰]
        C1 --> D1[Repository ìë™ ìŠ¤ìº” âœ…]
    end

    subgraph "DataJpaTest"
        A2[DataJpaTest] --> B2[JPA ê´€ë ¨ë§Œ ë¡œë“œ]
        B2 --> C2[ComponentScan ë¹„í™œì„±í™”]
        C2 --> D2[Repository ìë™ ìŠ¤ìº” âŒ]
    end

    subgraph "JpaBeanInitializer ì¶”ê°€"
        A3[DataJpaTest +<br/>JpaBeanInitializer] --> B3[JPA ê´€ë ¨ë§Œ ë¡œë“œ]
        B3 --> C3[Initializerê°€ ìˆ˜ë™ ìŠ¤ìº”]
        C3 --> D3[Repository ë“±ë¡ âœ…]
    end

    style D2 fill:#ff6b6b
    style D3 fill:#51cf66
```

**DataJpaTest ë‚´ë¶€ ë™ì‘**:

```java
// @DataJpaTest ì• ë…¸í…Œì´ì…˜ ì •ì˜
@OverrideAutoConfiguration(enabled = false)  // ğŸ‘ˆ ìë™ ì„¤ì • ë”!
@TypeExcludeFilters(DataJpaTypeExcludeFilter.class)  // ğŸ‘ˆ í•„í„°ë§!
@Transactional
@AutoConfigureDataJpa
public @interface DataJpaTest {
}
```

**í•µì‹¬**:
- `OverrideAutoConfiguration(enabled = false)`: ì¼ë°˜ì ì¸ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº” ë¹„í™œì„±í™”
- `TypeExcludeFilters`: JPA ê´€ë ¨ë§Œ í¬í•¨
- **ê²°ê³¼**: Repositoryê°€ ìë™ìœ¼ë¡œ ìŠ¤ìº”ë˜ì§€ ì•ŠìŒ!

**JpaBeanInitializerì˜ ì—­í• **:
```java
// ë¹„í™œì„±í™”ëœ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰
ClassPathScanningCandidateComponentProvider scanner =
    new ClassPathScanningCandidateComponentProvider(false);

scanner.addIncludeFilter(new AnnotationTypeFilter(Repository.class));
var beans = scanner.findCandidateComponents("com.concurrency");

// ì°¾ì€ ê²ƒë“¤ì„ ìˆ˜ë™ìœ¼ë¡œ ë“±ë¡
for (var bean : beans) {
    registry.registerBeanDefinition(beanName, bean);
}
```

---

## 5. Introspector ì›ë¦¬

### JavaBeans ëª…ëª… ê·œì¹™

```mermaid
graph LR
    A[í´ë˜ìŠ¤ëª…<br/>Full Qualified Name] --> B[Introspector.decapitalize]
    B --> C[Spring Bean ì´ë¦„]

    A1[ProductRepository] --> B
    B --> C1[productRepository]

    A2[UserService] --> B
    B --> C2[userService]

    A3[XMLParser] --> B
    B --> C3[XMLParser ê·¸ëŒ€ë¡œ!]

    style C1 fill:#51cf66
    style C2 fill:#51cf66
    style C3 fill:#ff6b6b
```

### Introspector êµ¬í˜„ ì½”ë“œ

```java
// JavaBeans ê·œì¹™:
// 1. ì²« ê¸€ìë§Œ ëŒ€ë¬¸ì â†’ ì†Œë¬¸ìë¡œ
// 2. ì²« ë‘ ê¸€ìê°€ ëª¨ë‘ ëŒ€ë¬¸ì â†’ ê·¸ëŒ€ë¡œ

public class Introspector {
    public static String decapitalize(String name) {
        if (name == null || name.length() == 0) {
            return name;
        }

        // ì²« ë‘ ê¸€ìê°€ ëª¨ë‘ ëŒ€ë¬¸ìë©´ ê·¸ëŒ€ë¡œ ë¦¬í„´
        if (name.length() > 1 &&
            Character.isUpperCase(name.charAt(0)) &&
            Character.isUpperCase(name.charAt(1))) {
            return name;  // XMLParser â†’ XMLParser
        }

        // ì²« ê¸€ìë§Œ ì†Œë¬¸ìë¡œ
        char chars[] = name.toCharArray();
        chars[0] = Character.toLowerCase(chars[0]);
        return new String(chars);  // ProductRepository â†’ productRepository
    }
}
```

### ì‚¬ìš© ì˜ˆì‹œ

```java
System.out.println(Introspector.decapitalize("ProductRepository"));
// â†’ productRepository

System.out.println(Introspector.decapitalize("UserService"));
// â†’ userService

System.out.println(Introspector.decapitalize("XMLParser"));
// â†’ XMLParser (ë³€ê²½ ì—†ìŒ! ë‘ ê¸€ìê°€ ëŒ€ë¬¸ì)

System.out.println(Introspector.decapitalize("URL"));
// â†’ URL (ë³€ê²½ ì—†ìŒ!)

System.out.println(Introspector.decapitalize("Url"));
// â†’ url
```

### JpaBeanInitializerì—ì„œ ì‚¬ìš©

```java
// BeanDefinitionì—ì„œ í´ë˜ìŠ¤ëª… ì¶”ì¶œ
String fullName = definition.getBeanClassName();
// â†’ "com.concurrency.shop.domain.product.ProductRepository"

// ë¹ˆ ì´ë¦„ ìƒì„±
String beanName = Introspector.decapitalize(
    fullName.substring(fullName.lastIndexOf('.') + 1)
);
// â†’ "productRepository"

beanFactory.registerBeanDefinition(beanName, definition);
```

```mermaid
graph LR
    A[com.concurrency.shop.domain<br/>.product.ProductRepository] --> B[ProductRepository<br/>ì¶”ì¶œ]
    B --> C[Introspector.decapitalize]
    C --> D[productRepository]

    style D fill:#51cf66
```

### ì™œ Introspectorë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

1. **JavaBeans í‘œì¤€ ì¤€ìˆ˜**: Springì€ JavaBeans ìŠ¤í™ì„ ë”°ë¦„
2. **ì¼ê´€ì„±**: ëª¨ë“  Bean ì´ë¦„ì´ ë™ì¼í•œ ê·œì¹™ìœ¼ë¡œ ìƒì„±ë¨
3. **ì˜ˆì™¸ ì¼€ì´ìŠ¤ ì²˜ë¦¬**: XML, URL ê°™ì€ ì•½ì–´ë„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬

---

## 6. Futureì™€ CompletableFuture

### Level 1: ë™ì‹œì„± vs ë³‘ë ¬ì„±

```mermaid
graph TB
    subgraph "ë™ì‹œì„± Concurrency - 1ê°œ CPU"
        A1[Task A]
        B1[Task B]
        Note1[ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„<br/>ì‹¤ì œë¡œëŠ” ë²ˆê°ˆì•„ê°€ë©° ì‹¤í–‰]
    end

    subgraph "ë³‘ë ¬ì„± Parallelism - ì—¬ëŸ¬ CPU"
        A2[Task A<br/>CPU 1]
        B2[Task B<br/>CPU 2]
        Note2[ì‹¤ì œë¡œ ë™ì‹œì— ì‹¤í–‰]
    end

    style A1 fill:#4dabf7
    style B1 fill:#51cf66
    style A2 fill:#4dabf7
    style B2 fill:#51cf66
```

**í•µì‹¬ ì°¨ì´**:
- **ë™ì‹œì„± (Concurrency)**: ì—¬ëŸ¬ ì‘ì—…ì´ ë™ì‹œì— ì§„í–‰ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì‹œê°„ì„ ë‚˜ëˆ ì„œ ë²ˆê°ˆì•„ê°€ë©° ì‹¤í–‰ (Context Switching)
- **ë³‘ë ¬ì„± (Parallelism)**: ì—¬ëŸ¬ CPU ì½”ì–´ì—ì„œ ì‹¤ì œë¡œ ë™ì‹œì— ì‹¤í–‰

### Level 2: Threadì˜ ì§„í™”

#### 1ë‹¨ê³„: Thread ì§ì ‘ ìƒì„± (ì˜›ë‚  ë°©ì‹)

```java
Thread thread1 = new Thread(() -> {
    System.out.println("ì‘ì—… 1 ì‹¤í–‰");
});

Thread thread2 = new Thread(() -> {
    System.out.println("ì‘ì—… 2 ì‹¤í–‰");
});

thread1.start();
thread2.start();

thread1.join();  // ì™„ë£Œ ëŒ€ê¸°
thread2.join();
```

**ë¬¸ì œì **:
- Thread ìƒì„± ë¹„ìš©ì´ í¼
- Thread ìˆ˜ ì œì–´ ì–´ë ¤ì›€
- ê²°ê³¼ ë°›ê¸° ì–´ë ¤ì›€

#### 2ë‹¨ê³„: ExecutorService - Thread Pool

```mermaid
graph TB
    subgraph "ExecutorService Thread Pool"
        A[Thread 1<br/>ëŒ€ê¸° ì¤‘]
        B[Thread 2<br/>ëŒ€ê¸° ì¤‘]
        C[Thread 3<br/>ëŒ€ê¸° ì¤‘]
    end

    subgraph "ì‘ì—… í"
        D[Task 1]
        E[Task 2]
        F[Task 3]
        G[Task 4]
        H[Task 5]
    end

    D --> A
    E --> B
    F --> C

    style A fill:#51cf66
    style B fill:#51cf66
    style C fill:#51cf66
```

```java
// Thread Pool ìƒì„± (3ê°œ ìŠ¤ë ˆë“œ)
ExecutorService executor = Executors.newFixedThreadPool(3);

// ì‘ì—… ì œì¶œ
for (int i = 0; i < 10; i++) {
    final int taskNum = i;
    executor.submit(() -> {
        System.out.println("Task " + taskNum + " ì‹¤í–‰: "
            + Thread.currentThread().getName());
        Thread.sleep(1000);
    });
}

// ì¢…ë£Œ
executor.shutdown();  // ìƒˆ ì‘ì—… ë°›ì§€ ì•ŠìŒ
executor.awaitTermination(10, TimeUnit.SECONDS);  // ì™„ë£Œ ëŒ€ê¸°
```

**ì¥ì **:
- Thread ì¬ì‚¬ìš© (ìƒì„± ë¹„ìš© ì ˆê°)
- Thread ìˆ˜ ì œì–´ ê°€ëŠ¥
- ì‘ì—… íë¡œ ê´€ë¦¬

#### 3ë‹¨ê³„: Future - ë¯¸ë˜ì˜ ê²°ê³¼

```mermaid
sequenceDiagram
    participant Main as ë©”ì¸ ìŠ¤ë ˆë“œ
    participant Executor as ExecutorService
    participant Worker as ì‘ì—… ìŠ¤ë ˆë“œ
    participant Future as Future ê°ì²´

    Main->>Executor: submit(task)
    Executor->>Worker: ì‘ì—… í• ë‹¹
    Executor-->>Main: Future ê°ì²´ ë¦¬í„´
    Note over Main: ë‹¤ë¥¸ ì¼ ê³„ì† ìˆ˜í–‰

    Worker->>Worker: ì‘ì—… ì‹¤í–‰ ì¤‘...

    Main->>Future: get í˜¸ì¶œ
    Note over Future: ì‘ì—… ì™„ë£Œê¹Œì§€ ëŒ€ê¸° â³

    Worker->>Future: ì‘ì—… ì™„ë£Œ! ê²°ê³¼ ì €ì¥
    Future-->>Main: ê²°ê³¼ ë¦¬í„´
```

```java
ExecutorService executor = Executors.newFixedThreadPool(1);

// Callable: ê²°ê³¼ë¥¼ ë¦¬í„´í•˜ëŠ” ì‘ì—…
Callable<Integer> task = () -> {
    Thread.sleep(2000);  // 2ì´ˆ ì‘ì—…
    return 42;
};

// Future ë°›ê¸°
Future<Integer> future = executor.submit(task);

System.out.println("ì‘ì—… ì œì¶œ ì™„ë£Œ, ë‹¤ë¥¸ ì¼ ìˆ˜í–‰ ê°€ëŠ¥");
// ë‹¤ë¥¸ ì‘ì—…...

// ê²°ê³¼ ë°›ê¸° (ë¸”ë¡œí‚¹!)
Integer result = future.get();  // 2ì´ˆ ëŒ€ê¸°
System.out.println("ê²°ê³¼: " + result);  // 42

executor.shutdown();
```

**ë¬¸ì œì **:
- `get()` í˜¸ì¶œ ì‹œ ë¸”ë¡œí‚¹ë¨
- Callback ì§€ì› ì•ˆ í•¨
- ì—¬ëŸ¬ Future ì¡°í•© ì–´ë ¤ì›€

#### 4ë‹¨ê³„: CompletableFuture - ê°œì„ ëœ ë¹„ë™ê¸°

```mermaid
graph LR
    A[Task ì‹œì‘] --> B[CompletableFuture ìƒì„±]
    B --> C[thenApply<br/>ê²°ê³¼ ë³€í™˜]
    C --> D[thenAccept<br/>ê²°ê³¼ ì†Œë¹„]
    D --> E[exceptionally<br/>ì˜ˆì™¸ ì²˜ë¦¬]

    style B fill:#4dabf7
    style C fill:#51cf66
    style E fill:#ff6b6b
```

```java
// ë¹„ë™ê¸° ì‘ì—… ì‹œì‘
CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {
    System.out.println("ì‘ì—… ì‹œì‘: " + Thread.currentThread().getName());
    sleep(2000);
    return 42;
});

// Callback ì²´ì´ë‹
future
    .thenApply(result -> result * 2)  // 42 â†’ 84
    .thenAccept(result -> {
        System.out.println("ìµœì¢… ê²°ê³¼: " + result);  // 84
    });

System.out.println("ë©”ì¸ ìŠ¤ë ˆë“œëŠ” ê³„ì† ì‹¤í–‰");
```

### ì—¬ëŸ¬ Future ì¡°í•©

```java
CompletableFuture<Integer> future1 = CompletableFuture.supplyAsync(() -> {
    sleep(1000);
    return 10;
});

CompletableFuture<Integer> future2 = CompletableFuture.supplyAsync(() -> {
    sleep(1000);
    return 20;
});

// ë‘˜ ë‹¤ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
CompletableFuture<Void> combined = CompletableFuture.allOf(future1, future2);
combined.join();  // ë¸”ë¡œí‚¹

System.out.println("ê²°ê³¼ 1: " + future1.get());  // 10
System.out.println("ê²°ê³¼ 2: " + future2.get());  // 20
```

### Level 3: ì§€ì¸ ì½”ë“œì˜ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ íŒ¨í„´

```java
// 1ë‹¨ê³„ Thread Pool ìƒì„± (10ê°œ ìŠ¤ë ˆë“œ)
final var executor = Executors.newFixedThreadPool(10);

// 2ë‹¨ê³„ 10ê°œì˜ CompletableFuture ìƒì„±
var futures = IntStream.range(0, 10)
    .mapToObj(it -> CompletableFuture.runAsync(() -> {
        pointServiceV2.usePoints(userEntity.getId(), targetUsePont, targetOrderId);
    }, executor))
    .toArray(CompletableFuture[]::new);

// 3ë‹¨ê³„ ëª¨ë“  ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
CompletableFuture.allOf(futures).join();

// 4ë‹¨ê³„ ExecutorService ì¢…ë£Œ
executor.shutdown();
```

### ë‹¨ê³„ë³„ ì‹¤í–‰ íë¦„

```mermaid
sequenceDiagram
    participant Test as í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ
    participant Executor as ThreadPool(10ê°œ)
    participant DB as MySQL

    Note over Test,DB: 1ë‹¨ê³„ ë°ì´í„° ì¤€ë¹„
    Test->>DB: User ì €ì¥ (balance: 10,000)

    Note over Test,DB: 2ë‹¨ê³„ 10ê°œ ì‘ì—… ì œì¶œ
    Test->>Executor: runAsync Ã— 10

    par Thread 1
        Executor->>DB: SELECT ... FOR UPDATE
        DB-->>Executor: User (ë½ íšë“)
        Executor->>DB: UPDATE balance
    and Thread 2
        Executor->>DB: SELECT ... FOR UPDATE
        Note over DB: ëŒ€ê¸° â³ (ë½ ëŒ€ê¸°)
    and Thread 3-10
        Executor->>DB: SELECT ... FOR UPDATE
        Note over DB: ëŒ€ê¸° â³
    end

    Note over Test,DB: 3ë‹¨ê³„ ëª¨ë“  ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
    Test->>Test: allOf.join

    Note over Test,DB: 4ë‹¨ê³„ ê²°ê³¼ ê²€ì¦
    Test->>DB: SELECT balance
    DB-->>Test: 0 âœ…
```

### í•µì‹¬ íŒ¨í„´ 4ê°€ì§€

#### Pattern 1: runAsync - ê²°ê³¼ ì—†ëŠ” ë¹„ë™ê¸° ì‹¤í–‰

```java
CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
    // ë¦¬í„´ê°’ ì—†ëŠ” ì‘ì—…
    pointService.usePoints(userId, 1000L);
});
```

#### Pattern 2: supplyAsync - ê²°ê³¼ ìˆëŠ” ë¹„ë™ê¸° ì‹¤í–‰

```java
CompletableFuture<User> future = CompletableFuture.supplyAsync(() -> {
    // ë¦¬í„´ê°’ ìˆëŠ” ì‘ì—…
    return userRepository.findById(1L).orElseThrow();
});

User user = future.join();  // ê²°ê³¼ ë°›ê¸°
```

#### Pattern 3: allOf - ì—¬ëŸ¬ ì‘ì—… ëŒ€ê¸°

```java
CompletableFuture<Void>[] futures = IntStream.range(0, 10)
    .mapToObj(i -> CompletableFuture.runAsync(() -> {
        // ì‘ì—…
    }))
    .toArray(CompletableFuture[]::new);

CompletableFuture.allOf(futures).join();  // ëª¨ë‘ ì™„ë£Œ ëŒ€ê¸°
```

#### Pattern 4: ExecutorService ì§€ì •

```java
ExecutorService executor = Executors.newFixedThreadPool(10);

CompletableFuture.runAsync(() -> {
    // ì‘ì—…
}, executor);  // ğŸ‘ˆ íŠ¹ì • ThreadPool ì‚¬ìš©

executor.shutdown();  // ì¢…ë£Œ í•„ìˆ˜!
```

---

## ì „ì²´ ìš”ì•½ ë° ë‹¤ìŒ í•™ìŠµ

### ì˜¤ëŠ˜ í•™ìŠµí•œ í•µì‹¬ ê°œë…

#### 1. JpaBeanInitializer

```mermaid
graph LR
    A[DataJpaTest] --> B[ComponentScan ë¹„í™œì„±]
    B --> C[JpaBeanInitializer]
    C --> D[Repository ìˆ˜ë™ ìŠ¤ìº”]
    D --> E[BeanDefinition ë“±ë¡]

    style C fill:#ff6b6b
```

**í•µì‹¬**:
- ApplicationContextInitializerë¡œ Context ì´ˆê¸°í™” ì „ì— ì‹¤í–‰
- BeanDefinition ë“±ë¡ â†’ Bean Instance ìƒì„± ìˆœì„œ
- Introspectorë¡œ JavaBeans ê·œì¹™ ì ìš©

#### 2. TestTransactionSupport

```mermaid
graph LR
    A[í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„] --> B[REQUIRES_NEW]
    B --> C[ì¦‰ì‹œ ì»¤ë°‹]
    C --> D[Worker Threadì—ì„œ<br/>ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥]

    style B fill:#ff6b6b
```

**í•µì‹¬**:
- REQUIRES_NEWë¡œ ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘ ë° ì¦‰ì‹œ ì»¤ë°‹
- ë™ì‹œì„± í…ŒìŠ¤íŠ¸ì—ì„œ Worker Threadë“¤ì´ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ í•¨

#### 3. AutoMockExtension

```mermaid
graph LR
    A[PER_CLASS] --> B[Mock 1ê°œ]
    B --> C[afterEachì—ì„œ<br/>reset]
    C --> D[í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ë³´ì¥]

    style C fill:#ff6b6b
```

**í•µì‹¬**:
- BeforeAllì—ì„œ Mock ê°ì²´ë“¤ì„ Setì— ì €ì¥
- AfterEachì—ì„œ Mockito.reset() í˜¸ì¶œ
- ì„±ëŠ¥ + í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ì–‘ë¦½

#### 4. CompletableFuture

```mermaid
graph LR
    A[Thread] --> B[ExecutorService]
    B --> C[Future]
    C --> D[CompletableFuture]

    style D fill:#51cf66
```

**í•µì‹¬**:
- Thread Poolë¡œ Thread ì¬ì‚¬ìš©
- CompletableFutureë¡œ Callback ì²´ì´ë‹
- allOfë¡œ ì—¬ëŸ¬ ì‘ì—… ëŒ€ê¸°

### í•™ìŠµ ì§„í–‰ë„

```mermaid
graph LR
    A[Phase 1<br/>ê¸°ë³¸ ê°œë… âœ…] --> B[Phase 2<br/>ì¸í”„ë¼ ì´í•´ âœ…]
    B --> C[Phase 2 ë‚¨ì€ ë¶€ë¶„<br/>CountDownLatch<br/>ì‹¤ì „ ì˜ˆì œ]

    style A fill:#51cf66
    style B fill:#51cf66
    style C fill:#ffd43b
```

### ë‹¤ìŒ í•™ìŠµ ì£¼ì œ (Phase 2 ë‚¨ì€ ë¶€ë¶„)

#### 1. CountDownLatch - ì •ë°€í•œ ë™ì‹œ ì‹œì‘ ì œì–´ (15ë¶„)

```java
// ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ë™ì‹œ ì‹œì‘
CountDownLatch latch = new CountDownLatch(10);

for (int i = 0; i < 10; i++) {
    executor.submit(() -> {
        latch.countDown();  // ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
        latch.await();      // ëª¨ë‘ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        // ì—¬ê¸°ì„œ ë™ì‹œì— ì‹œì‘!
        pointService.usePoints(...);
    });
}
```

#### 2. ì‹¤ì „ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì˜ˆì œ (30ë¶„)

- í¬ì¸íŠ¸ ë”°ë‹¥ ë°©ì§€ í…ŒìŠ¤íŠ¸
- ì¬ê³  ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸
- ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦
- Pessimistic Lock í…ŒìŠ¤íŠ¸

#### 3. ì „ì²´ ì •ë¦¬ ë° ë¦¬íŒ©í† ë§ (15ë¶„)

- ì§€ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œ êµ¬ì¡° ì „ì²´ ë³µìŠµ
- ë‚˜ë§Œì˜ í…ŒìŠ¤íŠ¸ ì¸í”„ë¼ ì„¤ê³„ ì—°ìŠµ

### ê´€ë ¨ í‚¤ì›Œë“œ

- ApplicationContextInitializer
- BeanDefinition vs Bean Instance
- Reflection API
- JavaBeans Specification
- Transaction Propagation (REQUIRES_NEW)
- TestInstance Lifecycle (PER_CLASS)
- Mock Lifecycle Management
- Concurrency vs Parallelism
- Thread Pool Pattern
- Future Pattern
- CompletableFuture Callback

---

## ì°¸ê³  íŒŒì¼ ìœ„ì¹˜

```
src/test/java/
â”œâ”€â”€ support/
â”‚   â”œâ”€â”€ JpaBeanInitializer.java          â­ Context ì´ˆê¸°í™”
â”‚   â”œâ”€â”€ TestTransactionSupport.java      â­ íŠ¸ëœì­ì…˜ ë¶„ë¦¬
â”‚   â”œâ”€â”€ AutoMockExtension.java           â­ Mock ê´€ë¦¬
â”‚   â”œâ”€â”€ AbstractTest.java
â”‚   â”œâ”€â”€ AbstractJpaTest.java
â”‚   â”œâ”€â”€ AbstractIntegrationServiceTest.java
â”‚   â””â”€â”€ AbstractConcurrencyTest.java     â­ ë‹¤ìŒ í•™ìŠµ
â””â”€â”€ com/concurrency/shop/service/v2/concurrency/
    â””â”€â”€ PointServiceV2ConcurrencyTest.java â­ ì‹¤ì „ ì˜ˆì œ
```

---

**ì‘ì„±ì¼**: 2025-10-20
**ë‹¤ìŒ í•™ìŠµ**: Phase 2 ë‚¨ì€ ë¶€ë¶„ - CountDownLatch ë° ì‹¤ì „ ì˜ˆì œ
**ì˜ˆìƒ ì‹œê°„**: 60ë¶„
