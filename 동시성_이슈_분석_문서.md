# λ™μ‹μ„± μ΄μ μ™„λ²½ κ°€μ΄λ“: V1 vs V2 λΉ„κµ λ¶„μ„

## λ©μ°¨
1. [κ°μ”](#κ°μ”)
2. [λ™μ‹μ„± κΈ°μ΄ κ°λ…](#λ™μ‹μ„±-κΈ°μ΄-κ°λ…)
3. [Java λ™μ‹μ„± λ©”μ»¤λ‹μ¦](#java-λ™μ‹μ„±-λ©”μ»¤λ‹μ¦)
4. [Redis κΈ°μ΄ λ° λ¶„μ‚° λ½](#redis-κΈ°μ΄-λ°-λ¶„μ‚°-λ½)
5. [V1: λ™μ‹μ„± λ¬Έμ κ°€ μλ” λ²„μ „](#v1-λ™μ‹μ„±-λ¬Έμ κ°€-μλ”-λ²„μ „)
6. [λ™μ‹μ„± μ΄μ λ°μƒ μ›μΈ](#λ™μ‹μ„±-μ΄μ-λ°μƒ-μ›μΈ)
7. [V2: λ™μ‹μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν• λ²„μ „](#v2-λ™μ‹μ„±-λ¬Έμ λ¥Ό-ν•΄κ²°ν•-λ²„μ „)
8. [μ½”λ“λ³„ μƒμ„Έ λ¶„μ„](#μ½”λ“λ³„-μƒμ„Έ-λ¶„μ„)
9. [κ²°λ΅ ](#κ²°λ΅ )

---

## κ°μ”

μ΄ ν”„λ΅μ νΈλ” μ¨λΌμΈ μ‡Όν•‘λ°μ μ£Όλ¬Έ μ‹μ¤ν…μ„ κµ¬ν„ν•λ©°, **λ™μ‹μ„± μ΄μ**λ¥Ό λ‹¤λ£¨λ” λ‘ κ°€μ§€ λ²„μ „μ„ μ κ³µν•©λ‹λ‹¤:

- **V1**: λ™μ‹μ„± μ²λ¦¬κ°€ μ—†λ” λ²„μ „ (λ¬Έμ  λ°μƒ)
- **V2**: Redis λ¶„μ‚° λ½κ³Ό λΉ„κ΄€μ  λ½μ„ μ‚¬μ©ν• λ™μ‹μ„± μ²λ¦¬ λ²„μ „ (λ¬Έμ  ν•΄κ²°)

### μ£Όμ” κΈ°λ¥
- μƒν’ μ¬κ³  κ΄€λ¦¬
- μ‚¬μ©μ ν¬μΈνΈ κ΄€λ¦¬
- μΏ ν° μ‚¬μ© νμ κ΄€λ¦¬
- μ£Όλ¬Έ μƒμ„± λ° μ·¨μ†

---

## λ™μ‹μ„± κΈ°μ΄ κ°λ…

### λ™μ‹μ„±μ΄λ€?

**λ™μ‹μ„±(Concurrency)**μ€ μ—¬λ¬ μ‘μ—…μ΄ λ™μ‹μ— μ‹¤ν–‰λλ” κ²ƒμ²λΌ λ³΄μ΄λ” μƒνƒλ¥Ό λ§ν•©λ‹λ‹¤. μ‹¤μ λ΅λ” λΉ λ¥΄κ² λ²κ°μ•„κ°€λ©° μ‹¤ν–‰λκ±°λ‚, λ©€ν‹°μ½”μ–΄ μ‹μ¤ν…μ—μ„ μ§„μ§λ΅ λ™μ‹μ— μ‹¤ν–‰λ  μ μμµλ‹λ‹¤.

### μ™ λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν• κΉ?

μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„λ” μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹μ— κ°™μ€ μμ›(λ°μ΄ν„°)μ— μ ‘κ·Όν•  μ μμµλ‹λ‹¤. μλ¥Ό λ“¤μ–΄:

```
μ‹λ‚λ¦¬μ¤: μ¬κ³ κ°€ 1κ° λ‚¨μ€ μƒν’μ„ 2λ…μ μ‚¬μ©μκ°€ λ™μ‹μ— κµ¬λ§¤ν•λ ¤κ³  ν•  λ•

[μ‚¬μ©μ A]              [λ°μ΄ν„°λ² μ΄μ¤]              [μ‚¬μ©μ B]
   |                        |                         |
   |--1. μ¬κ³  μ΅°ν (1κ°)---->|                         |
   |                        |<----2. μ¬κ³  μ΅°ν (1κ°)---|
   |                        |                         |
   |--3. μ¬κ³  μ°¨κ° (1-1=0)->|                         |
   |                        |<----4. μ¬κ³  μ°¨κ° (1-1=0)|
   |                        |                         |
κ²°κ³Ό: μ¬κ³ κ°€ -1μ΄ λκ±°λ‚, 2λ… λ¨λ‘ κµ¬λ§¤ μ„±κ³µ (λ¬Έμ !)
```

### Race Condition (κ²½μ μƒνƒ)

**Race Condition**μ€ μ—¬λ¬ μ¤λ λ“λ‚ ν”„λ΅μ„Έμ¤κ°€ κ³µμ  μμ›μ— λ™μ‹μ— μ ‘κ·Όν•  λ•, μ‹¤ν–‰ μμ„μ— λ”°λΌ κ²°κ³Όκ°€ λ‹¬λΌμ§€λ” μƒν™©μ…λ‹λ‹¤.

```java
// λ¬Έμ κ°€ λλ” μ½”λ“ μμ‹
public void decreaseStock(Long productId, Integer quantity) {
    Product product = productRepository.findById(productId).get();  // 1. μ½κΈ°

    // μ—¬κΈ°μ„ λ‹¤λ¥Έ μ¤λ λ“κ°€ κ°μ…ν•  μ μμ! β οΈ

    product.setStock(product.getStock() - quantity);  // 2. μ“°κΈ°
}
```

**μ™ λ¬Έμ μΈκ°€?**
1. μ¤λ λ“ Aκ°€ μ¬κ³  10μ„ μ½μ
2. μ¤λ λ“ Bλ„ μ¬κ³  10μ„ μ½μ
3. μ¤λ λ“ Aκ°€ μ¬κ³ λ¥Ό 9λ΅ μ—…λ°μ΄νΈ
4. μ¤λ λ“ Bκ°€ μ¬κ³ λ¥Ό 9λ΅ μ—…λ°μ΄νΈ (μ¤λ λ“ Aμ μ—…λ°μ΄νΈκ°€ λ¬΄μ‹λ¨!)
5. κ²°κ³Ό: μ¬κ³ κ°€ 8μ΄ λμ–΄μ•Ό ν•λ”λ° 9κ°€ λ¨

---

## Java λ™μ‹μ„± λ©”μ»¤λ‹μ¦

### 1. Threadμ™€ λ©€ν‹°μ¤λ λ”©

Javaμ—μ„ κ° μ”μ²­μ€ λ³„λ„μ **Thread(μ¤λ λ“)**μ—μ„ μ²λ¦¬λ©λ‹λ‹¤.

```
[μ›Ή μ„λ²„ - Tomcat]
     |
     |-- Thread 1: μ‚¬μ©μ Aμ μ”μ²­ μ²λ¦¬
     |-- Thread 2: μ‚¬μ©μ Bμ μ”μ²­ μ²λ¦¬
     |-- Thread 3: μ‚¬μ©μ Cμ μ”μ²­ μ²λ¦¬
     |-- Thread 4: ...
```

### 2. Javaμ λ©”λ¨λ¦¬ λ¨λΈ

κ° μ¤λ λ“λ” μμ‹ λ§μ **μ‘μ—… λ©”λ¨λ¦¬(Working Memory)**λ¥Ό κ°€μ§€κ³  μκ³ , κ³µμ  λ°μ΄ν„°λ” **λ©”μΈ λ©”λ¨λ¦¬(Main Memory)**μ— μ €μ¥λ©λ‹λ‹¤.

```
[Thread A]          [Main Memory]          [Thread B]
 Working Memory         |                Working Memory
    |                   |                      |
    |-- Read ---------> |                      |
    |                   |                      |
    |                   | <-------- Read ------|
    |                   |                      |
    |-- Write --------> |                      |
    |                   | <------- Write ------|
```

**λ¬Έμ μ **: μ‘μ—… λ©”λ¨λ¦¬μ™€ λ©”μΈ λ©”λ¨λ¦¬ κ°„μ λ™κΈ°ν™”κ°€ μ¦‰μ‹ μ΄λ£¨μ–΄μ§€μ§€ μ•μΌλ©΄ λ°μ΄ν„° λ¶μΌμΉκ°€ λ°μƒν•©λ‹λ‹¤.

### 3. λ™κΈ°ν™” λ©”μ»¤λ‹μ¦

#### (1) synchronized ν‚¤μ›λ“

```java
public synchronized void decreaseStock(Long productId, Integer quantity) {
    // ν• λ²μ— ν•λ‚μ μ¤λ λ“λ§ μ‹¤ν–‰ κ°€λ¥
    Product product = productRepository.findById(productId).get();
    product.setStock(product.getStock() - quantity);
}
```

**μ¥μ **: κ°„λ‹¨ν•κ³  ν™•μ‹¤ν• λ™κΈ°ν™”
**λ‹¨μ **: μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μ—¬λ¬ μ„λ²„μ— λ¶„μ‚°λμ–΄ μμΌλ©΄ μ†μ©μ—†μ (JVM λ‚΄λ¶€μ—μ„λ§ λ™μ‘)

#### (2) Lock μΈν„°νμ΄μ¤

```java
private final Lock lock = new ReentrantLock();

public void decreaseStock(Long productId, Integer quantity) {
    lock.lock();
    try {
        Product product = productRepository.findById(productId).get();
        product.setStock(product.getStock() - quantity);
    } finally {
        lock.unlock();
    }
}
```

**μ¥μ **: synchronizedλ³΄λ‹¤ μ μ—°ν•¨
**λ‹¨μ **: μ—¬μ „ν λ‹¨μΌ JVM λ‚΄μ—μ„λ§ λ™μ‘

### 4. λ°μ΄ν„°λ² μ΄μ¤ λ λ²¨μ λ½

#### (1) λΉ„κ΄€μ  λ½ (Pessimistic Lock)

"λ‹¤λ¥Έ μ‚¬λμ΄ μμ •ν•  κ²ƒ κ°™μΌλ‹ λ―Έλ¦¬ μ κ°€λ²„λ¦¬μ!"

```sql
SELECT * FROM products WHERE id = 1 FOR UPDATE;
```

- λ°μ΄ν„°λ¥Ό μ½λ” μκ°„ λ½μ„ κ±Έμ–΄λ²„λ¦Ό
- λ‹¤λ¥Έ νΈλμ­μ…μ€ ν•΄λ‹Ή λ°μ΄ν„°λ¥Ό μ½κ±°λ‚ μ“Έ μ μ—†μ
- νΈλμ­μ…μ΄ λλ‚λ©΄ λ½μ΄ ν•΄μ λ¨

#### (2) λ‚™κ΄€μ  λ½ (Optimistic Lock)

"λ€λ¶€λ¶„ μ¶©λμ΄ μ—†μ„ κ±°μ•Ό! μ¶©λλ‚λ©΄ κ·Έλ• μ²λ¦¬ν•μ."

```java
@Entity
public class Product {
    @Version
    private Long version;  // λ²„μ „ ν•„λ“
}
```

- λ°μ΄ν„°λ¥Ό μ½μ„ λ•λ” λ½μ„ κ±Έμ§€ μ•μ
- μ—…λ°μ΄νΈν•  λ• λ²„μ „μ΄ λ³€κ²½λμ—λ”μ§€ ν™•μΈ
- λ²„μ „μ΄ λ‹¤λ¥΄λ©΄ μμ™Έ λ°μƒ (λ‹¤λ¥Έ μ‚¬λμ΄ μμ •ν–λ‹¤λ” μλ―Έ)

---

## Redis κΈ°μ΄ λ° λ¶„μ‚° λ½

### Redisλ€?

**Redis**λ” λ©”λ¨λ¦¬ κΈ°λ°μ ν‚¤-κ°’(Key-Value) μ €μ¥μ†μ…λ‹λ‹¤. λ§¤μ° λΉ λ¥΄κ³ , λ‹¤μ–‘ν• μλ£κµ¬μ΅°λ¥Ό μ§€μ›ν•©λ‹λ‹¤.

```
[Redis μ„λ²„]
Key: "user:1:name"    Value: "ν™κΈΈλ™"
Key: "product:5:stock" Value: "100"
Key: "lock:order:user:1" Value: "thread-123"
```

### Redisμ νΉμ§•

1. **μ‹±κΈ€ μ¤λ λ“**: Redisλ” λ‹¨μΌ μ¤λ λ“λ΅ λ™μ‘ν•λ―€λ΅, λ…λ Ήμ–΄κ°€ μ›μμ (Atomic)μΌλ΅ μ‹¤ν–‰λ©λ‹λ‹¤.
2. **μΈλ©”λ¨λ¦¬**: λ””μ¤ν¬κ°€ μ•„λ‹ λ©”λ¨λ¦¬μ— λ°μ΄ν„°λ¥Ό μ €μ¥ν•λ―€λ΅ λ§¤μ° λΉ λ¦…λ‹λ‹¤.
3. **λ¶„μ‚° ν™κ²½ μ§€μ›**: μ—¬λ¬ μ• ν”λ¦¬μΌ€μ΄μ… μ„λ²„μ—μ„ κ³µμ ν•  μ μμµλ‹λ‹¤.

### Redisλ¥Ό μ‚¬μ©ν• λ¶„μ‚° λ½

λ¶„μ‚° λ½μ€ **μ—¬λ¬ μ„λ²„μ— κ±Έμ³ μλ” μ• ν”λ¦¬μΌ€μ΄μ…λ“¤μ΄ κ³µμ  μμ›μ— λ€ν• μ ‘κ·Όμ„ μ μ–΄**ν•κΈ° μ„ν• λ©”μ»¤λ‹μ¦μ…λ‹λ‹¤.

```
[μ„λ²„ 1]              [Redis]              [μ„λ²„ 2]
   |                     |                     |
   |--1. λ½ νλ“ μ”μ²­--->|                     |
   |<--2. μ„±κ³µ-----------|                     |
   |                     |<--3. λ½ νλ“ μ”μ²­---|
   |                     |---4. μ‹¤ν¨ (λ€κΈ°)--->|
   |                     |                     |
   |--5. μ‘μ—… μν–‰       |                     |
   |                     |                     |
   |--6. λ½ ν•΄μ -------->|                     |
   |                     |<--7. λ½ νλ“ μ¬μ‹λ„-|
   |                     |---8. μ„±κ³µ---------->|
```

### Redisson λΌμ΄λΈλ¬λ¦¬

μ΄ ν”„λ΅μ νΈμ—μ„λ” **Redisson**μ„ μ‚¬μ©ν•μ—¬ λ¶„μ‚° λ½μ„ κµ¬ν„ν•©λ‹λ‹¤.

```java
RLock lock = redissonClient.getLock("lock:order:user:1");

try {
    // λ½ νλ“ μ‹λ„ (waitTime: 10μ΄, leaseTime: 3μ΄)
    boolean isLocked = lock.tryLock(10, 3, TimeUnit.SECONDS);

    if (isLocked) {
        // μ‘μ—… μν–‰
        processOrder();
    }
} finally {
    lock.unlock();  // λ°λ“μ‹ λ½ ν•΄μ !
}
```

**μ£Όμ” νλΌλ―Έν„°**:
- **waitTime**: λ½μ„ νλ“ν•κΈ° μ„ν•΄ κΈ°λ‹¤λ¦¬λ” μµλ€ μ‹κ°„
- **leaseTime**: λ½μ„ μλ™μΌλ΅ ν•΄μ ν•λ” μ‹κ°„ (λ°λ“λ½ λ°©μ§€)

### Redisμ μ›μμ  μ—°μ‚°

Redisλ” λ‹¤μκ³Ό κ°™μ€ μ›μμ  μ—°μ‚°μ„ μ κ³µν•©λ‹λ‹¤:

```redis
SETNX key value  # keyκ°€ μ—†μΌλ©΄ μ„¤μ •, μμΌλ©΄ μ‹¤ν¨ (μ›μμ )
EXPIRE key 10    # keyμ λ§λ£ μ‹κ°„ μ„¤μ •
DEL key          # key μ‚­μ 
```

μ΄λ¬ν• μ›μμ  μ—°μ‚° λ•λ¶„μ— λ¶„μ‚° λ½μ„ μ•μ „ν•κ² κµ¬ν„ν•  μ μμµλ‹λ‹¤.

---

## V1: λ™μ‹μ„± λ¬Έμ κ°€ μλ” λ²„μ „

### V1 μ•„ν‚¤ν…μ² λ° μƒνΈμ‘μ©

```mermaid
graph TB
    subgraph "Client Requests"
        Client1[μ‚¬μ©μ A<br/>μ£Όλ¬Έ μ”μ²­]
        Client2[μ‚¬μ©μ B<br/>μ£Όλ¬Έ μ”μ²­]
    end

    subgraph "Spring Application"
        Controller1[OrderControllerV1]
        OrderService1[OrderServiceV1]
        StockService1[StockServiceV1]
        PointService1[PointServiceV1]

        Controller1 --> OrderService1
        OrderService1 --> StockService1
        OrderService1 --> PointService1
    end

    subgraph "Repositories"
        ProductRepo[ProductRepository]
        UserRepo[UserRepository]
        CouponRepo[CouponRepository]

        StockService1 --> ProductRepo
        PointService1 --> UserRepo
        OrderService1 --> CouponRepo
    end

    subgraph "Database"
        MySQL[(MySQL Database)]
        Products[Products ν…μ΄λΈ”]
        Users[Users ν…μ΄λΈ”]
        Coupons[Coupons ν…μ΄λΈ”]

        MySQL --> Products
        MySQL --> Users
        MySQL --> Coupons
    end

    Client1 --> Controller1
    Client2 --> Controller1
    ProductRepo --> MySQL
    UserRepo --> MySQL
    CouponRepo --> MySQL

    style Client1 fill:#ff6b6b
    style Client2 fill:#ff6b6b
    style MySQL fill:#4dabf7
    style OrderService1 fill:#ffd43b
    style StockService1 fill:#ffd43b
    style PointService1 fill:#ffd43b
```

### V1 μ£Όλ¬Έ μ²λ¦¬ νλ¦„

```mermaid
sequenceDiagram
    participant Client as ν΄λΌμ΄μ–ΈνΈ
    participant Controller as OrderControllerV1
    participant OrderService as OrderServiceV1
    participant StockService as StockServiceV1
    participant PointService as PointServiceV1
    participant ProductRepo as ProductRepository
    participant UserRepo as UserRepository
    participant CouponRepo as CouponRepository
    participant MySQL as MySQL DB

    Client->>Controller: POST /api/v1/orders
    Controller->>OrderService: createOrder(request)

    Note over OrderService: @Transactional μ‹μ‘

    OrderService->>UserRepo: findById(userId)
    UserRepo->>MySQL: SELECT * FROM users WHERE id = ?
    MySQL-->>UserRepo: User λ°μ΄ν„°
    UserRepo-->>OrderService: User

    OrderService->>StockService: decreaseStock(productId, quantity)
    StockService->>ProductRepo: findById(productId)
    ProductRepo->>MySQL: SELECT * FROM products WHERE id = ?
    MySQL-->>ProductRepo: Product (μ¬κ³ : 100)
    ProductRepo-->>StockService: Product

    Note over StockService: β οΈ Race Condition λ°μƒ μ§€μ !
    Note over StockService: μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ μ¬κ³ (100)λ¥Ό μ½μ

    StockService->>StockService: product.decreaseStock(quantity)
    StockService->>ProductRepo: save(product)
    ProductRepo->>MySQL: UPDATE products SET stock = ? WHERE id = ?

    OrderService->>CouponRepo: findById(couponId)
    CouponRepo->>MySQL: SELECT * FROM coupons WHERE id = ?
    MySQL-->>CouponRepo: Coupon (usedCount: 5)
    CouponRepo-->>OrderService: Coupon

    Note over OrderService: β οΈ Race Condition λ°μƒ μ§€μ !
    Note over OrderService: μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ usedCountλ¥Ό μ½μ

    OrderService->>OrderService: coupon.use()
    OrderService->>CouponRepo: save(coupon)
    CouponRepo->>MySQL: UPDATE coupons SET used_count = ? WHERE id = ?

    OrderService->>PointService: usePoints(userId, points)
    PointService->>UserRepo: findById(userId)
    UserRepo->>MySQL: SELECT * FROM users WHERE id = ?
    MySQL-->>UserRepo: User (ν¬μΈνΈ: 10000)
    UserRepo-->>PointService: User

    Note over PointService: β οΈ Race Condition λ°μƒ μ§€μ !
    Note over PointService: μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ ν¬μΈνΈλ¥Ό μ½μ

    PointService->>PointService: user.usePoints(points)
    PointService->>UserRepo: save(user)
    UserRepo->>MySQL: UPDATE users SET point_balance = ? WHERE id = ?

    Note over OrderService: @Transactional μΆ…λ£ (μ»¤λ°‹)

    OrderService-->>Controller: Order
    Controller-->>Client: 200 OK (μ£Όλ¬Έ μ™„λ£)
```

### V1μ λ¬Έμ μ  μ”μ•½

V1μ—μ„λ” λ‹¤μκ³Ό κ°™μ€ λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•©λ‹λ‹¤:

1. **μ¬κ³  λ™μ‹μ„± λ¬Έμ **: μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— κ°™μ€ μ¬κ³ λ¥Ό μ½κ³  μ°¨κ°
2. **ν¬μΈνΈ λ™μ‹μ„± λ¬Έμ **: μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— κ°™μ€ ν¬μΈνΈλ¥Ό μ½κ³  μ°¨κ°
3. **μΏ ν° λ™μ‹μ„± λ¬Έμ **: μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— μΏ ν° μ‚¬μ© νμλ¥Ό μ¦κ°€

---

## λ™μ‹μ„± μ΄μ λ°μƒ μ›μΈ

### λ¬Έμ  1: μ¬κ³  Race Condition

#### μ‹λ‚λ¦¬μ¤

μ¬κ³ κ°€ **100κ°** λ‚¨μ€ μƒν’μ— λ€ν•΄ **2λ…μ μ‚¬μ©μ**κ°€ λ™μ‹μ— κ°κ° **1κ°μ”©** κµ¬λ§¤

#### μ •μƒμ μΈ κ²½μ° (μμ°¨ μ²λ¦¬)

```
μ΄κΈ° μ¬κ³ : 100

[μ‚¬μ©μ A] κµ¬λ§¤ 1κ°
  1. μ¬κ³  μ΅°ν: 100
  2. μ¬κ³  μ°¨κ°: 100 - 1 = 99
  3. DB μ—…λ°μ΄νΈ: 99

[μ‚¬μ©μ B] κµ¬λ§¤ 1κ°
  1. μ¬κ³  μ΅°ν: 99
  2. μ¬κ³  μ°¨κ°: 99 - 1 = 98
  3. DB μ—…λ°μ΄νΈ: 98

μµμΆ… μ¬κ³ : 98 β… μ •μƒ
```

#### λ™μ‹μ„± μ΄μκ°€ μλ” κ²½μ° (V1)

```mermaid
sequenceDiagram
    participant A as μ¤λ λ“ A<br/>(μ‚¬μ©μ A)
    participant DB as MySQL<br/>(μ¬κ³ : 100)
    participant B as μ¤λ λ“ B<br/>(μ‚¬μ©μ B)

    Note over A,B: λ™μ‹μ— μ”μ²­ μ‹μ‘!

    A->>DB: 1. SELECT stock FROM products (μ¬κ³  μ΅°ν)
    DB-->>A: μ¬κ³ : 100

    B->>DB: 2. SELECT stock FROM products (μ¬κ³  μ΅°ν)
    DB-->>B: μ¬κ³ : 100

    Note over A: 3. κ³„μ‚°: 100 - 1 = 99
    Note over B: 4. κ³„μ‚°: 100 - 1 = 99

    A->>DB: 5. UPDATE products SET stock = 99
    B->>DB: 6. UPDATE products SET stock = 99

    Note over DB: μµμΆ… μ¬κ³ : 99 β (98μ΄μ–΄μ•Ό ν•¨!)
    Note over A,B: 2λ…μ΄ κµ¬λ§¤ν–λ”λ° μ¬κ³ κ°€ 1κ°λ§ μ¤„μ–΄λ“¦!
```

#### μ½”λ“μ—μ„ λ¬Έμ κ°€ λλ” λ¶€λ¶„

**StockServiceV1.java:23-35**

```java
@Transactional
public void decreaseStock(Long productId, Integer quantity) {
    log.info("[V1] μ¬κ³  μ°¨κ° μ‹μ‘ - μƒν’ ID: {}, μλ‰: {}", productId, quantity);

    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  1: λ™μ‹μ„± μ²λ¦¬ μ—†μ΄ λ‹¨μ μ΅°ν
    Product product = productRepository.findById(productId)
        .orElseThrow(() -> new IllegalArgumentException("μƒν’μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: " + productId));

    log.info("[V1] ν„μ¬ μ¬κ³ : {}", product.getStockQuantity());

    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  2: Race Condition λ°μƒ
    // μ—¬λ¬ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ μ¬κ³ λ¥Ό μ½κ³ , κ°μ κ³„μ‚°ν• ν›„ μ—…λ°μ΄νΈ
    // -> Lost Update λ¬Έμ  λ°μƒ
    product.decreaseStock(quantity);

    log.info("[V1] μ¬κ³  μ°¨κ° μ™„λ£ - λ‚¨μ€ μ¬κ³ : {}", product.getStockQuantity());
}
```

**λ¬Έμ μ **:
1. `findById()`λ” λ½μ„ κ±Έμ§€ μ•μ β†’ μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ λ°μ΄ν„°λ¥Ό μ½μ
2. κ° μ¤λ λ“κ°€ μ½μ€ μ‹μ μ μ¬κ³ λ¥Ό κΈ°μ¤€μΌλ΅ κ³„μ‚° β†’ μ¤‘κ°„μ— λ‹¤λ¥Έ μ¤λ λ“μ μ—…λ°μ΄νΈκ°€ λ°μλμ§€ μ•μ
3. λ‚μ¤‘μ— μ‹¤ν–‰λ μ—…λ°μ΄νΈκ°€ μ΄μ „ μ—…λ°μ΄νΈλ¥Ό λ®μ–΄μ”€ β†’ **Lost Update** λ¬Έμ 

### λ¬Έμ  2: ν¬μΈνΈ Race Condition

#### μ‹λ‚λ¦¬μ¤

ν¬μΈνΈ **10,000μ **μ„ κ°€μ§„ μ‚¬μ©μκ°€ **2κ°μ μ£Όλ¬Έ**μ„ λ™μ‹μ— μ‹¤ν–‰ν•μ—¬ κ°κ° **5,000μ μ”©** μ‚¬μ©

#### μ •μƒμ μΈ κ²½μ°

```
μ΄κΈ° ν¬μΈνΈ: 10,000

[μ£Όλ¬Έ 1] 5,000μ  μ‚¬μ©
  1. ν¬μΈνΈ μ΅°ν: 10,000
  2. ν¬μΈνΈ μ°¨κ°: 10,000 - 5,000 = 5,000
  3. DB μ—…λ°μ΄νΈ: 5,000

[μ£Όλ¬Έ 2] 5,000μ  μ‚¬μ©
  1. ν¬μΈνΈ μ΅°ν: 5,000
  2. ν¬μΈνΈ μ°¨κ°: 5,000 - 5,000 = 0
  3. DB μ—…λ°μ΄νΈ: 0

μµμΆ… ν¬μΈνΈ: 0 β… μ •μƒ
```

#### λ™μ‹μ„± μ΄μκ°€ μλ” κ²½μ°

```mermaid
sequenceDiagram
    participant T1 as μ¤λ λ“ 1<br/>(μ£Όλ¬Έ 1)
    participant DB as MySQL<br/>(ν¬μΈνΈ: 10,000)
    participant T2 as μ¤λ λ“ 2<br/>(μ£Όλ¬Έ 2)

    T1->>DB: SELECT point_balance (ν¬μΈνΈ μ΅°ν)
    DB-->>T1: 10,000μ 

    T2->>DB: SELECT point_balance (ν¬μΈνΈ μ΅°ν)
    DB-->>T2: 10,000μ 

    Note over T1: κ³„μ‚°: 10,000 - 5,000 = 5,000
    Note over T2: κ³„μ‚°: 10,000 - 5,000 = 5,000

    T1->>DB: UPDATE users SET point_balance = 5,000
    T2->>DB: UPDATE users SET point_balance = 5,000

    Note over DB: μµμΆ… ν¬μΈνΈ: 5,000 β (0μ΄μ–΄μ•Ό ν•¨!)
    Note over T1,T2: 10,000μ μ„ μ‚¬μ©ν–λ”λ° 5,000μ λ§ μ°¨κ°λ¨!
```

#### μ½”λ“μ—μ„ λ¬Έμ κ°€ λλ” λ¶€λ¶„

**PointServiceV1.java:26-44**

```java
@Transactional
public void usePoints(Long userId, Long points, Long orderId) {
    log.info("[V1] ν¬μΈνΈ μ‚¬μ© μ‹μ‘ - μ‚¬μ©μ ID: {}, μ‚¬μ© ν¬μΈνΈ: {}", userId, points);

    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  1: λ™μ‹μ„± μ²λ¦¬ μ—†μ΄ λ‹¨μ μ΅°ν
    User user = userRepository.findById(userId)
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤: " + userId));

    log.info("[V1] ν„μ¬ ν¬μΈνΈ μ”μ•΅: {}", user.getPointBalance());

    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  2: Race Condition λ°μƒ
    // μ—¬λ¬ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ μ”μ•΅μ„ μ½μ
    user.usePoints(points);

    // ν¬μΈνΈ μ‚¬μ© μ΄λ ¥ μ €μ¥
    PointHistory history = new PointHistory(user, PointType.USE, points, user.getPointBalance(), orderId);
    pointHistoryRepository.save(history);

    log.info("[V1] ν¬μΈνΈ μ‚¬μ© μ™„λ£ - λ‚¨μ€ ν¬μΈνΈ: {}", user.getPointBalance());
}
```

**User.java:38-45** (ν¬μΈνΈ μ°¨κ° λ΅μ§)

```java
public void usePoints(Long points) {
    // β οΈ κ²€μ¦μ€ μμ§€λ§, λ™μ‹μ„± λ¬Έμ λ΅ μΈν•΄ λ¬΄μ©μ§€λ¬Ό
    if (this.pointBalance < points) {
        throw new IllegalStateException(
            String.format("ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤. ν„μ¬: %d, ν•„μ”: %d", this.pointBalance, points)
        );
    }
    // β οΈ μ΄ κ³„μ‚°μ΄ μ—¬λ¬ μ¤λ λ“μ—μ„ λ™μ‹μ— μ‹¤ν–‰λλ©΄ λ¬Έμ  λ°μƒ
    this.pointBalance -= points;
}
```

**λ¬Έμ μ **:
1. λ‘ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ ν¬μΈνΈ μ”μ•΅(10,000)μ„ μ½μ
2. κ°κ° λ…λ¦½μ μΌλ΅ 5,000μ„ μ°¨κ° (10,000 - 5,000 = 5,000)
3. λ‘ νΈλμ­μ… λ¨λ‘ 5,000μΌλ΅ μ—…λ°μ΄νΈ
4. κ²°κ³Ό: 10,000μ μ„ μ‚¬μ©ν–μ§€λ§ 5,000μ λ§ μ°¨κ°λ¨ β†’ μ‚¬μ©μκ°€ λ¶€λ‹Ή μ΄λ“

### λ¬Έμ  3: μΏ ν° μ‚¬μ© νμ Race Condition

#### μ‹λ‚λ¦¬μ¤

μ‚¬μ© κ°€λ¥ νμκ°€ **10ν**μΈ μΏ ν°μ„, **ν„μ¬ 9ν** μ‚¬μ©λ μƒνƒμ—μ„ **3λ…μ μ‚¬μ©μ**κ°€ λ™μ‹μ— μ‚¬μ© μ‹λ„

#### μ •μƒμ μΈ κ²½μ°

```
μ΄κΈ° μ‚¬μ© νμ: 9/10

[μ‚¬μ©μ A] μΏ ν° μ‚¬μ©
  1. usedCount μ΅°ν: 9
  2. κ²€μ¦: 9 < 10 β†’ OK
  3. usedCount μ¦κ°€: 9 + 1 = 10
  4. DB μ—…λ°μ΄νΈ: 10

[μ‚¬μ©μ B] μΏ ν° μ‚¬μ©
  1. usedCount μ΅°ν: 10
  2. κ²€μ¦: 10 < 10 β†’ μ‹¤ν¨!
  3. μμ™Έ λ°μƒ: "μΏ ν° μ‚¬μ© κ°€λ¥ νμ μ΄κ³Ό"

μµμΆ… μ‚¬μ© νμ: 10/10 β… μ •μƒ
```

#### λ™μ‹μ„± μ΄μκ°€ μλ” κ²½μ°

```mermaid
sequenceDiagram
    participant A as μ‚¬μ©μ A
    participant B as μ‚¬μ©μ B
    participant C as μ‚¬μ©μ C
    participant DB as MySQL<br/>(usedCount: 9)

    Note over A,C: λ™μ‹μ— μΏ ν° μ‚¬μ© μ‹λ„!

    A->>DB: SELECT used_count (μ΅°ν)
    DB-->>A: 9
    B->>DB: SELECT used_count (μ΅°ν)
    DB-->>B: 9
    C->>DB: SELECT used_count (μ΅°ν)
    DB-->>C: 9

    Note over A: κ²€μ¦: 9 < 10 β†’ OK β…
    Note over B: κ²€μ¦: 9 < 10 β†’ OK β…
    Note over C: κ²€μ¦: 9 < 10 β†’ OK β…

    Note over A: κ³„μ‚°: 9 + 1 = 10
    Note over B: κ³„μ‚°: 9 + 1 = 10
    Note over C: κ³„μ‚°: 9 + 1 = 10

    A->>DB: UPDATE coupons SET used_count = 10
    B->>DB: UPDATE coupons SET used_count = 10
    C->>DB: UPDATE coupons SET used_count = 10

    Note over DB: μµμΆ… μ‚¬μ© νμ: 10 β
    Note over A,C: 3λ…μ΄ μΏ ν°μ„ μ‚¬μ©ν–μ§€λ§, usedCountλ” 10!
    Note over A,C: μ›λλ” 1λ…λ§ μ„±κ³µν•΄μ•Ό ν•λ”λ° 3λ… λ¨λ‘ μ„±κ³µ!
```

#### μ½”λ“μ—μ„ λ¬Έμ κ°€ λλ” λ¶€λ¶„

**OrderServiceV1.java:64-78** (μΏ ν° μ‚¬μ©)

```java
// 4. μΏ ν° ν• μΈ μ²λ¦¬
Long discountAmount = 0L;
if (request.getCouponId() != null) {
    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  1: λ½ μ—†μ΄ μΏ ν° μ΅°ν
    Coupon coupon = couponRepository.findById(request.getCouponId())
        .orElseThrow(() -> new IllegalArgumentException("μΏ ν°μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: " + request.getCouponId()));

    log.info("[V1] μΏ ν° μ‚¬μ© - μΏ ν° ID: {}, ν„μ¬ μ‚¬μ© νμ: {}/{}",
        coupon.getId(), coupon.getUsedCount(), coupon.getTotalAvailableCount());

    // β οΈ λ¬Έμ  λ°μƒ μ§€μ  2: Race Condition λ°μƒ
    // μ—¬λ¬ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ usedCountλ¥Ό μ½κ³  μ¦κ°€
    coupon.use();
    discountAmount = coupon.calculateDiscount(order.getTotalAmount());

    log.info("[V1] μΏ ν° μ μ© μ™„λ£ - ν• μΈ κΈμ•΅: {}, μ‚¬μ© ν›„ νμ: {}",
        discountAmount, coupon.getUsedCount());
}
```

**Coupon.java:50-58** (μΏ ν° μ‚¬μ© λ΅μ§)

```java
public void use() {
    // β οΈ κ²€μ¦μ€ μμ§€λ§, μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ²€μ¦μ„ ν†µκ³Όν•  μ μμ
    if (this.usedCount >= this.totalAvailableCount) {
        throw new IllegalStateException(
            String.format("μΏ ν° μ‚¬μ© κ°€λ¥ νμλ¥Ό μ΄κ³Όν–μµλ‹λ‹¤. μΏ ν°λ…: %s, μµλ€: %d, ν„μ¬: %d",
                this.name, this.totalAvailableCount, this.usedCount)
        );
    }
    // β οΈ μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— μ΄ λΌμΈμ„ μ‹¤ν–‰ν•λ©΄ λ¬Έμ  λ°μƒ
    this.usedCount++;
}
```

**λ¬Έμ μ **:
1. 3κ°μ νΈλμ­μ…μ΄ λ¨λ‘ usedCount = 9λ¥Ό μ½μ
2. λ¨λ‘ κ²€μ¦ ν†µκ³Ό (9 < 10)
3. κ°κ° usedCountλ¥Ό 10μΌλ΅ μ—…λ°μ΄νΈ
4. κ²°κ³Ό: 3λ… λ¨λ‘ μΏ ν° μ‚¬μ© μ„±κ³µ β†’ μΏ ν° νμ μ ν•μ΄ λ¬΄μλ―Έν•΄μ§

---

## V2: λ™μ‹μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν• λ²„μ „

### V2 μ•„ν‚¤ν…μ² λ° μƒνΈμ‘μ©

```mermaid
graph TB
    subgraph "Client Requests"
        Client1[μ‚¬μ©μ A<br/>μ£Όλ¬Έ μ”μ²­]
        Client2[μ‚¬μ©μ B<br/>μ£Όλ¬Έ μ”μ²­]
    end

    subgraph "Spring Application"
        Controller2[OrderControllerV2]
        OrderService2[OrderServiceV2<br/>@DistributedLock]
        StockService2[StockServiceV2<br/>λΉ„κ΄€μ  λ½]
        PointService2[PointServiceV2<br/>@DistributedLock]

        LockAop[DistributedLockAop<br/>AOP]
        RedisLockService[RedisLockService]

        Controller2 --> OrderService2
        OrderService2 --> StockService2
        OrderService2 --> PointService2
        OrderService2 -.-> LockAop
        PointService2 -.-> LockAop
        LockAop --> RedisLockService
    end

    subgraph "Repositories"
        ProductRepo2[ProductRepository<br/>SELECT FOR UPDATE]
        UserRepo2[UserRepository<br/>SELECT FOR UPDATE]
        CouponRepo2[CouponRepository<br/>SELECT FOR UPDATE]

        StockService2 --> ProductRepo2
        PointService2 --> UserRepo2
        OrderService2 --> CouponRepo2
    end

    subgraph "External Systems"
        Redis[(Redis<br/>λ¶„μ‚° λ½ κ΄€λ¦¬)]
        MySQL2[(MySQL Database)]

        Products2[Products ν…μ΄λΈ”]
        Users2[Users ν…μ΄λΈ”]
        Coupons2[Coupons ν…μ΄λΈ”]

        MySQL2 --> Products2
        MySQL2 --> Users2
        MySQL2 --> Coupons2
    end

    Client1 --> Controller2
    Client2 --> Controller2
    RedisLockService <--> Redis
    ProductRepo2 --> MySQL2
    UserRepo2 --> MySQL2
    CouponRepo2 --> MySQL2

    style Client1 fill:#ff6b6b
    style Client2 fill:#ff6b6b
    style Redis fill:#ff6b6b,color:#fff
    style MySQL2 fill:#4dabf7
    style OrderService2 fill:#51cf66
    style StockService2 fill:#51cf66
    style PointService2 fill:#51cf66
    style LockAop fill:#ffd43b
    style RedisLockService fill:#ffd43b
```

### V2 μ£Όλ¬Έ μ²λ¦¬ νλ¦„ (λ¶„μ‚° λ½ + λΉ„κ΄€μ  λ½)

```mermaid
sequenceDiagram
    participant Client as ν΄λΌμ΄μ–ΈνΈ
    participant Controller as OrderControllerV2
    participant AOP as DistributedLockAop
    participant Redis as Redis
    participant OrderService as OrderServiceV2
    participant StockService as StockServiceV2
    participant PointService as PointServiceV2
    participant ProductRepo as ProductRepository
    participant CouponRepo as CouponRepository
    participant MySQL as MySQL DB

    Client->>Controller: POST /api/v2/orders
    Controller->>AOP: createOrder(request) νΈμ¶

    Note over AOP: @DistributedLock κ°μ§€
    AOP->>Redis: tryLock("order:create:user:1", 10s, 10s)

    alt λ½ νλ“ μ„±κ³µ
        Redis-->>AOP: λ½ νλ“ μ„±κ³µ β…
        AOP->>OrderService: proceed() - μ‹¤μ  λ©”μ„λ“ μ‹¤ν–‰

        Note over OrderService: @Transactional μ‹μ‘

        OrderService->>StockService: decreaseStock(productId, quantity)
        StockService->>ProductRepo: findByIdWithPessimisticLock(productId)

        Note over ProductRepo: SELECT * FROM products<br/>WHERE id = ? FOR UPDATE
        Note over MySQL: π”’ Row Lock νλ“ (λΉ„κ΄€μ  λ½)

        ProductRepo->>MySQL: SELECT FOR UPDATE
        MySQL-->>ProductRepo: Product (μ¬κ³ : 100) + λ½
        ProductRepo-->>StockService: Product

        Note over StockService: β… λ½μ„ νλ“ν–μΌλ―€λ΅<br/>λ‹¤λ¥Έ μ¤λ λ“λ” λ€κΈ° μ¤‘

        StockService->>StockService: product.decreaseStock(quantity)
        StockService->>ProductRepo: save(product)
        ProductRepo->>MySQL: UPDATE products SET stock = 99

        Note over MySQL: π”“ νΈλμ­μ… μΆ…λ£ μ‹ λ½ ν•΄μ 

        OrderService->>CouponRepo: findByIdWithPessimisticLock(couponId)

        Note over CouponRepo: SELECT * FROM coupons<br/>WHERE id = ? FOR UPDATE

        CouponRepo->>MySQL: SELECT FOR UPDATE
        MySQL-->>CouponRepo: Coupon (usedCount: 5) + λ½
        CouponRepo-->>OrderService: Coupon

        OrderService->>OrderService: coupon.use()
        OrderService->>CouponRepo: save(coupon)
        CouponRepo->>MySQL: UPDATE coupons SET used_count = 6

        OrderService->>PointService: usePoints(userId, points)

        Note over PointService: @DistributedLock μ μ©

        PointService->>Redis: tryLock("user:point:1", 5s, 3s)
        Redis-->>PointService: λ½ νλ“ μ„±κ³µ

        PointService->>PointService: ν¬μΈνΈ μ°¨κ° λ΅μ§ μ‹¤ν–‰
        PointService->>Redis: unlock("user:point:1")

        Note over OrderService: @Transactional μΆ…λ£ (μ»¤λ°‹)
        Note over MySQL: π”“ λ¨λ“  λ½ ν•΄μ 

        OrderService-->>AOP: Order λ°ν™
        AOP->>Redis: unlock("order:create:user:1")
        Redis-->>AOP: λ½ ν•΄μ  μ™„λ£
        AOP-->>Controller: Order
        Controller-->>Client: 200 OK

    else λ½ νλ“ μ‹¤ν¨
        Redis-->>AOP: λ½ νλ“ μ‹¤ν¨ β (λ‹¤λ¥Έ μ”μ²­μ΄ μ²λ¦¬ μ¤‘)
        AOP-->>Controller: IllegalStateException
        Controller-->>Client: 409 Conflict (μ μ‹ ν›„ μ¬μ‹λ„)
    end
```

### V2μ ν•΄κ²° λ°©λ²•

#### 1. λΉ„κ΄€μ  λ½ (Pessimistic Lock)

**μ μ© λ€μƒ**: μ¬κ³  κ΄€λ¦¬, μΏ ν° μ‚¬μ© νμ

**ProductRepository.java:13-15**

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.id = :id")
Optional<Product> findByIdWithPessimisticLock(@Param("id") Long id);
```

**μ‹¤μ  μ‹¤ν–‰λλ” SQL**:

```sql
SELECT * FROM products WHERE id = ? FOR UPDATE;
```

**λ™μ‘ λ°©μ‹**:
1. `SELECT FOR UPDATE`λ΅ λ°μ΄ν„°λ¥Ό μ΅°νν•λ©΄ ν•΄λ‹Ή Rowμ— **λ°°νƒ€μ  λ½(Exclusive Lock)**μ΄ κ±Έλ¦Ό
2. λ‹¤λ¥Έ νΈλμ­μ…μ€ ν•΄λ‹Ή Rowλ¥Ό μ½κ±°λ‚ μ“Έ μ μ—†μ (λ€κΈ° μƒνƒλ΅ μ „ν™)
3. νΈλμ­μ…μ΄ μ»¤λ°‹λλ©΄ λ½μ΄ μλ™μΌλ΅ ν•΄μ λ¨

**StockServiceV2.java:22-36** (λΉ„κ΄€μ  λ½ μ‚¬μ©)

```java
@Transactional
public void decreaseStock(Long productId, Integer quantity) {
    log.info("[V2] μ¬κ³  μ°¨κ° μ‹μ‘ (λΉ„κ΄€μ  λ½) - μƒν’ ID: {}, μλ‰: {}", productId, quantity);

    // β… ν•΄κ²°: λΉ„κ΄€μ  λ½μΌλ΅ μ΅°ν - SELECT FOR UPDATE
    Product product = productRepository.findByIdWithPessimisticLock(productId)
        .orElseThrow(() -> new IllegalArgumentException("μƒν’μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: " + productId));

    log.info("[V2] λ½ νλ“ μ™„λ£ - ν„μ¬ μ¬κ³ : {}", product.getStockQuantity());

    // β… λ½μ„ νλ“ν–μΌλ―€λ΅ μ•μ „ν•κ² μ¬κ³  μ°¨κ° κ°€λ¥
    // λ‹¤λ¥Έ νΈλμ­μ…μ€ λ€κΈ° μ¤‘
    product.decreaseStock(quantity);

    log.info("[V2] μ¬κ³  μ°¨κ° μ™„λ£ - λ‚¨μ€ μ¬κ³ : {}", product.getStockQuantity());
}
```

**λΉ„κ΄€μ  λ½ λ™μ‘ μ‹κ°ν™”**:

```
μ‹κ°„ β†’   νΈλμ­μ… A                          νΈλμ­μ… B
β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
  t1     SELECT FOR UPDATE (μ¬κ³ : 100)
         π”’ λ½ νλ“
  t2                                        SELECT FOR UPDATE
                                            β³ λ€κΈ° μ¤‘...
  t3     μ¬κ³  μ°¨κ°: 100 - 1 = 99
  t4     UPDATE stock = 99
  t5     COMMIT
         π”“ λ½ ν•΄μ 
  t6                                        π”’ λ½ νλ“ (μ¬κ³ : 99)
  t7                                        μ¬κ³  μ°¨κ°: 99 - 1 = 98
  t8                                        UPDATE stock = 98
  t9                                        COMMIT
                                            π”“ λ½ ν•΄μ 

μµμΆ… μ¬κ³ : 98 β… μ •μƒ!
```

#### 2. Redis λ¶„μ‚° λ½ (Distributed Lock)

**μ μ© λ€μƒ**: ν¬μΈνΈ κ΄€λ¦¬, μ „μ²΄ μ£Όλ¬Έ ν”„λ΅μ„Έμ¤

**DistributedLock.java** (μ»¤μ¤ν…€ μ• λ…Έν…μ΄μ…)

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DistributedLock {
    String key();              // λ½ ν‚¤ (SpEL ν‘ν„μ‹ μ§€μ›)
    long waitTime() default 5L; // λ½ νλ“ λ€κΈ° μ‹κ°„
    long leaseTime() default 3L; // λ½ μ μ  μ‹κ°„ (μλ™ ν•΄μ )
    TimeUnit timeUnit() default TimeUnit.SECONDS;
}
```

**PointServiceV2.java:27-45** (λ¶„μ‚° λ½ μ‚¬μ©)

```java
// β… ν•΄κ²°: Redis λ¶„μ‚° λ½ μ μ©
@DistributedLock(key = "'user:point:' + #userId", waitTime = 5, leaseTime = 3)
@Transactional
public void usePoints(Long userId, Long points, Long orderId) {
    log.info("[V2] ν¬μΈνΈ μ‚¬μ© μ‹μ‘ (λ¶„μ‚° λ½) - μ‚¬μ©μ ID: {}, μ‚¬μ© ν¬μΈνΈ: {}", userId, points);

    User user = userRepository.findById(userId)
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤: " + userId));

    log.info("[V2] λ¶„μ‚° λ½ νλ“ μ™„λ£ - ν„μ¬ ν¬μΈνΈ μ”μ•΅: {}", user.getPointBalance());

    // β… λ¶„μ‚° λ½μ„ νλ“ν–μΌλ―€λ΅ μ•μ „ν•κ² ν¬μΈνΈ μ°¨κ° κ°€λ¥
    // λ‹¤λ¥Έ μ„λ²„μ μ”μ²­λ„ λ€κΈ° μ¤‘
    user.usePoints(points);

    PointHistory history = new PointHistory(user, PointType.USE, points, user.getPointBalance(), orderId);
    pointHistoryRepository.save(history);

    log.info("[V2] ν¬μΈνΈ μ‚¬μ© μ™„λ£ - λ‚¨μ€ ν¬μΈνΈ: {}", user.getPointBalance());
}
```

**DistributedLockAop.java:30-57** (AOPλ΅ λ¶„μ‚° λ½ κµ¬ν„)

```java
@Around("@annotation(distributedLock)")
public Object lock(ProceedingJoinPoint joinPoint, DistributedLock distributedLock) throws Throwable {
    MethodSignature signature = (MethodSignature) joinPoint.getSignature();
    Method method = signature.getMethod();

    // SpEL ν‘ν„μ‹μΌλ΅ λ™μ  ν‚¤ μƒμ„±
    // μ: "'user:point:' + #userId" β†’ "user:point:1"
    String lockKey = generateLockKey(signature, joinPoint.getArgs(), distributedLock.key());

    log.info("λ¶„μ‚° λ½ νλ“ μ‹λ„ - Key: {}, Method: {}", lockKey, method.getName());

    // Redisμ— λ½ νλ“ μ‹λ„
    boolean locked = redisLockService.tryLock(
        lockKey,
        distributedLock.waitTime(),   // λ€κΈ° μ‹κ°„: 5μ΄
        distributedLock.leaseTime(),  // μ μ  μ‹κ°„: 3μ΄
        distributedLock.timeUnit()
    );

    if (!locked) {
        throw new IllegalStateException(
            String.format("λ½ νλ“ μ‹¤ν¨: %s (λ‹¤λ¥Έ μ”μ²­μ΄ μ²λ¦¬ μ¤‘μ…λ‹λ‹¤)", lockKey)
        );
    }

    try {
        // μ‹¤μ  λΉ„μ¦λ‹μ¤ λ΅μ§ μ‹¤ν–‰
        return joinPoint.proceed();
    } finally {
        // λ°λ“μ‹ λ½ ν•΄μ  (try-finallyλ΅ λ³΄μ¥)
        redisLockService.unlock(lockKey);
        log.info("λ¶„μ‚° λ½ ν•΄μ  μ™„λ£ - Key: {}", lockKey);
    }
}
```

**RedisLockService.java:21-36** (Redis λ½ κµ¬ν„)

```java
public boolean tryLock(String lockKey, long waitTime, long leaseTime, TimeUnit timeUnit) {
    // Redissonμ RLock μ‚¬μ©
    RLock lock = redissonClient.getLock(lockKey);

    try {
        // λ½ νλ“ μ‹λ„
        // waitTime: λ½μ„ κΈ°λ‹¤λ¦¬λ” μµλ€ μ‹κ°„
        // leaseTime: λ½μ΄ μλ™μΌλ΅ ν•΄μ λλ” μ‹κ°„ (λ°λ“λ½ λ°©μ§€)
        boolean isLocked = lock.tryLock(waitTime, leaseTime, timeUnit);

        if (isLocked) {
            log.debug("λ½ νλ“ μ„±κ³µ: {}", lockKey);
        } else {
            log.warn("λ½ νλ“ μ‹¤ν¨: {} (λ€κΈ° μ‹κ°„ μ΄κ³Ό)", lockKey);
        }
        return isLocked;
    } catch (InterruptedException e) {
        log.error("λ½ νλ“ μ¤‘ μΈν„°λ½νΈ λ°μƒ: {}", lockKey, e);
        Thread.currentThread().interrupt();
        return false;
    }
}
```

**Redis λ¶„μ‚° λ½ λ™μ‘ μ‹κ°ν™”**:

```
      μ„λ²„ 1 (μ”μ²­ A)          Redis                μ„λ²„ 2 (μ”μ²­ B)
β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
  t1   tryLock("user:point:1")
       π”’ λ½ νλ“ μ„±κ³µ
       Redisμ— ν‚¤ μ €μ¥:
       Key: "user:point:1"
       Value: "μ„λ²„1-μ¤λ λ“A"
       TTL: 3μ΄

  t2                          Key μ΅΄μ¬              tryLock("user:point:1")
                                                   β λ½ νλ“ μ‹¤ν¨
                                                   5μ΄ λ™μ• μ¬μ‹λ„...

  t3   ν¬μΈνΈ μ°¨κ° μ²λ¦¬
       (10,000 β†’ 5,000)

  t4   unlock("user:point:1")
       π”“ λ½ ν•΄μ 
       Redisμ—μ„ ν‚¤ μ‚­μ 

  t5                          Key μ‚­μ λ¨            μ¬μ‹λ„...
                                                   π”’ λ½ νλ“ μ„±κ³µ!

  t6                                               ν¬μΈνΈ μ°¨κ° μ²λ¦¬
                                                   (5,000 β†’ 0)

  t7                                               unlock("user:point:1")
                                                   π”“ λ½ ν•΄μ 
```

### V2μ™€ V1μ λΉ„κµ

| ν•­λ© | V1 (λ¬Έμ ) | V2 (ν•΄κ²°) |
|------|----------|----------|
| **μ¬κ³  κ΄€λ¦¬** | μΌλ° SELECT β†’ Race Condition | `SELECT FOR UPDATE` (λΉ„κ΄€μ  λ½) |
| **ν¬μΈνΈ κ΄€λ¦¬** | μΌλ° SELECT β†’ Race Condition | Redis λ¶„μ‚° λ½ |
| **μΏ ν° κ΄€λ¦¬** | μΌλ° SELECT β†’ Race Condition | `SELECT FOR UPDATE` (λΉ„κ΄€μ  λ½) |
| **λ¶„μ‚° ν™κ²½** | μ§€μ› μ• ν•¨ | Redisλ΅ μ—¬λ¬ μ„λ²„ κ°„ λ™κΈ°ν™” |
| **λ°λ“λ½ λ°©μ§€** | μ—†μ | Redis λ½μ μλ™ λ§λ£ (leaseTime) |

---

## μ½”λ“λ³„ μƒμ„Έ λ¶„μ„

### 1. StockService λΉ„κµ

#### V1: λ™μ‹μ„± λ¬Έμ 

```java
// StockServiceV1.java
@Transactional
public void decreaseStock(Long productId, Integer quantity) {
    // β μΌλ° μ΅°ν: λ½ μ—†μ
    Product product = productRepository.findById(productId)
        .orElseThrow(() -> new IllegalArgumentException("μƒν’μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    // β Race Condition λ°μƒ μ§€μ 
    // μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ μ¬κ³ λ¥Ό μ½κ³  μ°¨κ°
    product.decreaseStock(quantity);

    // β Lost Update: λ‚μ¤‘ μ—…λ°μ΄νΈκ°€ μ΄μ „ μ—…λ°μ΄νΈλ¥Ό λ®μ–΄μ”€
}
```

**λ°μƒ κ°€λ¥ν• μ‹λ‚λ¦¬μ¤**:
```
μ΄κΈ° μ¬κ³ : 100

μ¤λ λ“ A: findById() β†’ μ¬κ³  100 μ½μ
μ¤λ λ“ B: findById() β†’ μ¬κ³  100 μ½μ (Aμ λ³€κ²½ μ „)
μ¤λ λ“ A: decreaseStock(10) β†’ μ¬κ³  90μΌλ΅ κ³„μ‚°
μ¤λ λ“ B: decreaseStock(20) β†’ μ¬κ³  80μΌλ΅ κ³„μ‚° (100 κΈ°μ¤€)
μ¤λ λ“ A: save() β†’ DBμ— 90 μ €μ¥
μ¤λ λ“ B: save() β†’ DBμ— 80 μ €μ¥ (Aμ λ³€κ²½ λ¬΄μ‹!)

μμƒ μ¬κ³ : 70 (100 - 10 - 20)
μ‹¤μ  μ¬κ³ : 80 β
μ°¨μ΄: 10κ° μ†μ‹¤!
```

#### V2: λΉ„κ΄€μ  λ½μΌλ΅ ν•΄κ²°

```java
// StockServiceV2.java
@Transactional
public void decreaseStock(Long productId, Integer quantity) {
    // β… λΉ„κ΄€μ  λ½μΌλ΅ μ΅°ν: SELECT FOR UPDATE
    Product product = productRepository.findByIdWithPessimisticLock(productId)
        .orElseThrow(() -> new IllegalArgumentException("μƒν’μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    // β… λ½μ„ νλ“ν–μΌλ―€λ΅ μ•μ „
    // λ‹¤λ¥Έ μ¤λ λ“λ” μ΄ νΈλμ­μ…μ΄ λλ‚  λ•κΉμ§€ λ€κΈ°
    product.decreaseStock(quantity);
}
```

**ν•΄κ²°λ μ‹λ‚λ¦¬μ¤**:
```
μ΄κΈ° μ¬κ³ : 100

μ¤λ λ“ A: findByIdWithPessimisticLock() β†’ μ¬κ³  100 + π”’ λ½ νλ“
μ¤λ λ“ B: findByIdWithPessimisticLock() β†’ β³ λ€κΈ° (Aκ°€ λ½μ„ λ³΄μ  μ¤‘)
μ¤λ λ“ A: decreaseStock(10) β†’ μ¬κ³  90μΌλ΅ κ³„μ‚°
μ¤λ λ“ A: save() β†’ DBμ— 90 μ €μ¥
μ¤λ λ“ A: commit() β†’ νΈλμ­μ… μΆ…λ£, π”“ λ½ ν•΄μ 
μ¤λ λ“ B: β†’ π”’ λ½ νλ“, μ¬κ³  90 μ½μ (Aμ λ³€κ²½ λ°μ!)
μ¤λ λ“ B: decreaseStock(20) β†’ μ¬κ³  70μΌλ΅ κ³„μ‚°
μ¤λ λ“ B: save() β†’ DBμ— 70 μ €μ¥
μ¤λ λ“ B: commit() β†’ νΈλμ­μ… μΆ…λ£

μµμΆ… μ¬κ³ : 70 β… μ •μƒ!
```

### 2. PointService λΉ„κµ

#### V1: λ™μ‹μ„± λ¬Έμ 

```java
// PointServiceV1.java
@Transactional
public void usePoints(Long userId, Long points, Long orderId) {
    // β μΌλ° μ΅°ν: λ½ μ—†μ
    User user = userRepository.findById(userId)
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    // β Race Condition λ°μƒ
    user.usePoints(points);

    PointHistory history = new PointHistory(user, PointType.USE, points, user.getPointBalance(), orderId);
    pointHistoryRepository.save(history);
}
```

**λ°μƒ κ°€λ¥ν• μ‹λ‚λ¦¬μ¤**:
```
μ΄κΈ° ν¬μΈνΈ: 10,000

μ£Όλ¬Έ 1: findById() β†’ ν¬μΈνΈ 10,000 μ½μ
μ£Όλ¬Έ 2: findById() β†’ ν¬μΈνΈ 10,000 μ½μ (μ£Όλ¬Έ 1μ λ³€κ²½ μ „)
μ£Όλ¬Έ 3: findById() β†’ ν¬μΈνΈ 10,000 μ½μ (μ£Όλ¬Έ 1, 2μ λ³€κ²½ μ „)

μ£Όλ¬Έ 1: usePoints(3,000) β†’ 7,000μΌλ΅ κ³„μ‚°
μ£Όλ¬Έ 2: usePoints(3,000) β†’ 7,000μΌλ΅ κ³„μ‚° (10,000 κΈ°μ¤€)
μ£Όλ¬Έ 3: usePoints(3,000) β†’ 7,000μΌλ΅ κ³„μ‚° (10,000 κΈ°μ¤€)

μ£Όλ¬Έ 1: save() β†’ DBμ— 7,000 μ €μ¥
μ£Όλ¬Έ 2: save() β†’ DBμ— 7,000 μ €μ¥ (λ®μ–΄μ”€)
μ£Όλ¬Έ 3: save() β†’ DBμ— 7,000 μ €μ¥ (λ®μ–΄μ”€)

μμƒ ν¬μΈνΈ: 1,000 (10,000 - 3,000 * 3)
μ‹¤μ  ν¬μΈνΈ: 7,000 β
μ°¨μ΄: 6,000μ  μ†μ‹¤! (μ‚¬μ©μκ°€ λ¶€λ‹Ή μ΄λ“)
```

#### V2: Redis λ¶„μ‚° λ½μΌλ΅ ν•΄κ²°

```java
// PointServiceV2.java
@DistributedLock(key = "'user:point:' + #userId", waitTime = 5, leaseTime = 3)
@Transactional
public void usePoints(Long userId, Long points, Long orderId) {
    // β… λ¶„μ‚° λ½μ„ νλ“ν• μƒνƒμ—μ„ μ‹¤ν–‰
    User user = userRepository.findById(userId)
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    // β… μ•μ „ν•κ² ν¬μΈνΈ μ°¨κ°
    user.usePoints(points);

    PointHistory history = new PointHistory(user, PointType.USE, points, user.getPointBalance(), orderId);
    pointHistoryRepository.save(history);
}
```

**ν•΄κ²°λ μ‹λ‚λ¦¬μ¤**:
```
μ΄κΈ° ν¬μΈνΈ: 10,000

μ£Όλ¬Έ 1: Redis.tryLock("user:point:1") β†’ π”’ λ½ νλ“
μ£Όλ¬Έ 2: Redis.tryLock("user:point:1") β†’ β³ λ€κΈ° (5μ΄)
μ£Όλ¬Έ 3: Redis.tryLock("user:point:1") β†’ β³ λ€κΈ° (5μ΄)

μ£Όλ¬Έ 1: findById() β†’ ν¬μΈνΈ 10,000 μ½μ
μ£Όλ¬Έ 1: usePoints(3,000) β†’ 7,000μΌλ΅ κ³„μ‚°
μ£Όλ¬Έ 1: save() β†’ DBμ— 7,000 μ €μ¥
μ£Όλ¬Έ 1: commit()
μ£Όλ¬Έ 1: Redis.unlock("user:point:1") β†’ π”“ λ½ ν•΄μ 

μ£Όλ¬Έ 2: β†’ π”’ λ½ νλ“ (μ¬μ‹λ„ μ„±κ³µ)
μ£Όλ¬Έ 2: findById() β†’ ν¬μΈνΈ 7,000 μ½μ (μ£Όλ¬Έ 1 λ°μ!)
μ£Όλ¬Έ 2: usePoints(3,000) β†’ 4,000μΌλ΅ κ³„μ‚°
μ£Όλ¬Έ 2: save() β†’ DBμ— 4,000 μ €μ¥
μ£Όλ¬Έ 2: commit()
μ£Όλ¬Έ 2: Redis.unlock("user:point:1") β†’ π”“ λ½ ν•΄μ 

μ£Όλ¬Έ 3: β†’ π”’ λ½ νλ“
μ£Όλ¬Έ 3: findById() β†’ ν¬μΈνΈ 4,000 μ½μ (μ£Όλ¬Έ 1, 2 λ°μ!)
μ£Όλ¬Έ 3: usePoints(3,000) β†’ 1,000μΌλ΅ κ³„μ‚°
μ£Όλ¬Έ 3: save() β†’ DBμ— 1,000 μ €μ¥
μ£Όλ¬Έ 3: commit()
μ£Όλ¬Έ 3: Redis.unlock("user:point:1") β†’ π”“ λ½ ν•΄μ 

μµμΆ… ν¬μΈνΈ: 1,000 β… μ •μƒ!
```

### 3. OrderService λΉ„κµ

#### V1: λ™μ‹μ„± λ¬Έμ 

```java
// OrderServiceV1.java
@Transactional  // β νΈλμ­μ…λ§μΌλ΅λ” λ™μ‹μ„± λ³΄μ¥ μ• λ¨
public Order createOrder(OrderRequest request) {
    User user = userRepository.findById(request.getUserId())
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    Order order = new Order(user, request.getCouponId());

    // β μ¬κ³  μ°¨κ°: Race Condition
    for (OrderItemRequest itemRequest : request.getItems()) {
        stockServiceV1.decreaseStock(itemRequest.getProductId(), itemRequest.getQuantity());
        // ...
    }

    // β μΏ ν° μ‚¬μ©: Race Condition
    if (request.getCouponId() != null) {
        Coupon coupon = couponRepository.findById(request.getCouponId())
            .orElseThrow(() -> new IllegalArgumentException("μΏ ν°μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));
        coupon.use();  // usedCount++ (λ™μ‹μ„± μ΄μ)
        // ...
    }

    // β ν¬μΈνΈ μ‚¬μ©: Race Condition
    if (pointsToUse > 0) {
        pointServiceV1.usePoints(user.getId(), pointsToUse, null);
    }

    // ...
}
```

#### V2: μ „μ²΄ ν”„λ΅μ„Έμ¤μ— λ¶„μ‚° λ½ μ μ©

```java
// OrderServiceV2.java
// β… μ „μ²΄ μ£Όλ¬Έ ν”„λ΅μ„Έμ¤μ— λ¶„μ‚° λ½ μ μ©
@DistributedLock(key = "'order:create:user:' + #request.userId", waitTime = 10, leaseTime = 10)
@Transactional
public Order createOrder(OrderRequest request) {
    User user = userRepository.findById(request.getUserId())
        .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));

    Order order = new Order(user, request.getCouponId());

    // β… μ¬κ³  μ°¨κ°: λΉ„κ΄€μ  λ½ μ‚¬μ©
    for (OrderItemRequest itemRequest : request.getItems()) {
        stockServiceV2.decreaseStock(itemRequest.getProductId(), itemRequest.getQuantity());
        // ...
    }

    // β… μΏ ν° μ‚¬μ©: λΉ„κ΄€μ  λ½μΌλ΅ μ΅°ν
    if (request.getCouponId() != null) {
        Coupon coupon = couponRepository.findByIdWithPessimisticLock(request.getCouponId())
            .orElseThrow(() -> new IllegalArgumentException("μΏ ν°μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤"));
        coupon.use();  // λ½μ„ νλ“ν–μΌλ―€λ΅ μ•μ „
        // ...
    }

    // β… ν¬μΈνΈ μ‚¬μ©: λ¶„μ‚° λ½ μ‚¬μ© (PointServiceV2)
    if (pointsToUse > 0) {
        pointServiceV2.usePoints(user.getId(), pointsToUse, null);
    }

    // ...
}
```

**V2μ λ‹¤μΈµ λ½ μ „λµ**:
```
[λ λ²¨ 1] μ£Όλ¬Έ ν”„λ΅μ„Έμ¤ μ „μ²΄: Redis λ¶„μ‚° λ½
  β””β”€ Key: "order:create:user:1"
  β””β”€ κ°™μ€ μ‚¬μ©μμ λ™μ‹ μ£Όλ¬Έ λ°©μ§€

  [λ λ²¨ 2] μ¬κ³  μ°¨κ°: MySQL λΉ„κ΄€μ  λ½
    β””β”€ Query: SELECT FOR UPDATE
    β””β”€ μƒν’λ³„ μ¬κ³  λ™μ‹ μ ‘κ·Ό λ°©μ§€

  [λ λ²¨ 3] μΏ ν° μ‚¬μ©: MySQL λΉ„κ΄€μ  λ½
    β””β”€ Query: SELECT FOR UPDATE
    β””β”€ μΏ ν°λ³„ μ‚¬μ© νμ λ™μ‹ μ ‘κ·Ό λ°©μ§€

  [λ λ²¨ 4] ν¬μΈνΈ μ‚¬μ©: Redis λ¶„μ‚° λ½
    β””β”€ Key: "user:point:1"
    β””β”€ μ‚¬μ©μλ³„ ν¬μΈνΈ λ™μ‹ μ ‘κ·Ό λ°©μ§€
```

μ΄λ ‡κ² **μ—¬λ¬ μΈµμ λ½**μ„ μ΅°ν•©ν•μ—¬ λ™μ‹μ„±μ„ μ™„λ²½ν•κ² μ μ–΄ν•©λ‹λ‹¤.

---

## κ²°λ΅ 

### λ™μ‹μ„± λ¬Έμ μ ν•µμ‹¬

λ™μ‹μ„± λ¬Έμ λ” **μ—¬λ¬ μ¤λ λ“(λλ” ν”„λ΅μ„Έμ¤)κ°€ κ³µμ  μμ›μ— λ™μ‹μ— μ ‘κ·Όν•  λ•, μ„λ΅μ λ³€κ²½ μ‚¬ν•­μ„ μΈμ‹ν•μ§€ λ»ν•΄ λ°μƒ**ν•©λ‹λ‹¤.

### V1μ λ¬Έμ μ 

1. **μ¬κ³  κ΄€λ¦¬**: μ—¬λ¬ μ£Όλ¬Έμ΄ λ™μ‹μ— κ°™μ€ μ¬κ³ λ¥Ό μ½κ³  μ°¨κ° β†’ μ¬κ³  λ¶€μ •ν•©
2. **ν¬μΈνΈ κ΄€λ¦¬**: κ°™μ€ μ‚¬μ©μκ°€ λ™μ‹μ— ν¬μΈνΈ μ‚¬μ© β†’ ν¬μΈνΈ λ¶€μ •ν•©
3. **μΏ ν° κ΄€λ¦¬**: μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹μ— μΏ ν° μ‚¬μ© β†’ νμ μ ν• λ¬΄ν¨ν™”

### V2μ ν•΄κ²° λ°©λ²•

1. **λΉ„κ΄€μ  λ½ (Pessimistic Lock)**
   - μ μ©: μ¬κ³ , μΏ ν°
   - λ°©λ²•: `SELECT FOR UPDATE`λ΅ Row Lock
   - μ¥μ : ν™•μ‹¤ν• λ™μ‹μ„± μ μ–΄, κµ¬ν„ κ°„λ‹¨
   - λ‹¨μ : μ„±λ¥ μ €ν• (λ€κΈ° μ‹κ°„ λ°μƒ)

2. **Redis λ¶„μ‚° λ½ (Distributed Lock)**
   - μ μ©: ν¬μΈνΈ, μ „μ²΄ μ£Όλ¬Έ ν”„λ΅μ„Έμ¤
   - λ°©λ²•: Redisson + Redis
   - μ¥μ : λ¶„μ‚° ν™κ²½ μ§€μ›, μ μ—°ν• μ μ–΄
   - λ‹¨μ : μ¶”κ°€ μΈν”„λΌ ν•„μ” (Redis)

### μ‹¤λ¬΄ μ μ© κ°€μ΄λ“

| μ‹λ‚λ¦¬μ¤ | μ¶”μ² λ°©λ²• | μ΄μ  |
|---------|----------|------|
| λ‹¨μΌ ν…μ΄λΈ” μ—…λ°μ΄νΈ | λΉ„κ΄€μ  λ½ | κ°„λ‹¨ν•κ³  ν™•μ‹¤ν•¨ |
| μ—¬λ¬ ν…μ΄λΈ” μ—…λ°μ΄νΈ | λ¶„μ‚° λ½ | νΈλμ­μ… λ²”μ„ μ μ–΄ μ©μ΄ |
| λ¶„μ‚° ν™κ²½ (μ—¬λ¬ μ„λ²„) | λ¶„μ‚° λ½ | JVM λ½μ€ μ„λ²„ κ°„ κ³µμ  μ• λ¨ |
| λ†’μ€ λ™μ‹μ„± | λ‚™κ΄€μ  λ½ or λ©”μ‹μ§€ ν | λ½ λ€κΈ° μ‹κ°„ μµμ†ν™” |
| μ¬κ³  κ΄€λ¦¬ | λΉ„κ΄€μ  λ½ or Redis Decr | μ •ν™•μ„±μ΄ μµμ°μ„  |
| μ΅°ν μ„±λ¥ μ¤‘μ” | λ‚™κ΄€μ  λ½ | μ½κΈ° μ‹ λ½ μ—†μ |

### μ„±λ¥ vs μ •ν™•μ„± νΈλ μ΄λ“μ¤ν”„

```
[λ†’μ€ μ„±λ¥, λ‚®μ€ μ •ν™•μ„±]
  λ½ μ—†μ (V1)
    β†“
  λ‚™κ΄€μ  λ½
    β†“
  λ¶„μ‚° λ½ (Redis)
    β†“
  λΉ„κ΄€μ  λ½ (DB)
    β†“
  μ§λ ¬ν™” (Queue)
[λ‚®μ€ μ„±λ¥, λ†’μ€ μ •ν™•μ„±]
```

**μ„ νƒ κΈ°μ¤€**:
- κΈμµ κ±°λ, μ¬κ³  κ΄€λ¦¬: μ •ν™•μ„± μ°μ„  β†’ λΉ„κ΄€μ  λ½ or λ¶„μ‚° λ½
- ν†µκ³„, μΉ΄μ΄ν„°: μ•½κ°„μ μ¤μ°¨ ν—μ© β†’ λ‚™κ΄€μ  λ½ or λ½ μ—†μ
- λ€μ©λ‰ νΈλν”½: μ„±λ¥ μ°μ„  β†’ λ©”μ‹μ§€ νλ΅ λΉ„λ™κΈ° μ²λ¦¬

### μ¶”κ°€ ν•™μµ μλ£

1. **Java λ™μ‹μ„±**
   - `java.util.concurrent` ν¨ν‚¤μ§€
   - Thread, Runnable, ExecutorService
   - synchronized, volatile, Lock

2. **λ°μ΄ν„°λ² μ΄μ¤ λ½**
   - νΈλμ­μ… κ²©λ¦¬ μμ¤€ (Isolation Level)
   - λ°λ“λ½ (Deadlock) μ²λ¦¬
   - λ½ νƒ€μ„μ•„μ›ƒ μ„¤μ •

3. **Redis**
   - Redisson vs Lettuce
   - Redis Pub/Sub
   - Redis Cluster (λ¶„μ‚° ν™κ²½)

4. **λ¶„μ‚° μ‹μ¤ν…**
   - CAP μ΄λ΅ 
   - μ΄λ²¤νΈ κΈ°λ° μ•„ν‚¤ν…μ²
   - CQRS ν¨ν„΄

---

## λ¶€λ΅: μμ£Ό λ¬»λ” μ§λ¬Έ

### Q1: @Transactionalλ§μΌλ΅λ” λ™μ‹μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν•  μ μ—†λ‚μ”?

**A**: ν•  μ μ—†μµλ‹λ‹¤. `@Transactional`μ€ νΈλμ­μ…μ μ›μμ„±(Atomicity)μ„ λ³΄μ¥ν•μ§€λ§, λ™μ‹μ„± μ μ–΄λ” ν•μ§€ μ•μµλ‹λ‹¤.

```java
// @Transactionalμ€ μ΄λ ‡κ² λ™μ‘ν•©λ‹λ‹¤:
BEGIN TRANSACTION;
  SELECT * FROM products WHERE id = 1;  // λ½ μ—†μ!
  UPDATE products SET stock = stock - 1 WHERE id = 1;
COMMIT;

// μ—¬λ¬ νΈλμ­μ…μ΄ λ™μ‹μ— SELECTλ¥Ό μ‹¤ν–‰ν•λ©΄
// λ¨λ‘ κ°™μ€ κ°’μ„ μ½κ² λ©λ‹λ‹¤!
```

### Q2: λΉ„κ΄€μ  λ½ vs λ‚™κ΄€μ  λ½, μ–Έμ  λ­ μ¨μ•Ό ν•λ‚μ”?

**A**:
- **λΉ„κ΄€μ  λ½**: μ¶©λμ΄ μμ£Ό λ°μƒν•λ” κ²½μ° (μ¬κ³  κ΄€λ¦¬, μΆμ„ μλ§¤)
- **λ‚™κ΄€μ  λ½**: μ¶©λμ΄ λ“λ¬Έ κ²½μ° (λΈ”λ΅κ·Έ κ²μ‹κΈ€ μμ •, ν”„λ΅ν•„ μ—…λ°μ΄νΈ)

### Q3: Redis λ¶„μ‚° λ½μ leaseTimeμ€ μ™ ν•„μ”ν•κ°€μ”?

**A**: λ°λ“λ½ λ°©μ§€λ¥Ό μ„ν•΄μ„μ…λ‹λ‹¤. λ§μ•½ μ• ν”λ¦¬μΌ€μ΄μ…μ΄ ν¬λμ‹λμ–΄ unlock()μ„ νΈμ¶ν•μ§€ λ»ν•λ©΄, λ½μ΄ μμ›ν ν•΄μ λμ§€ μ•μ„ μ μμµλ‹λ‹¤. `leaseTime`μ„ μ„¤μ •ν•λ©΄ μΌμ • μ‹κ°„ ν›„ μλ™μΌλ΅ λ½μ΄ ν•΄μ λ©λ‹λ‹¤.

### Q4: λ¶„μ‚° λ½μ„ μ‚¬μ©ν•λ©΄ μ„±λ¥μ΄ λ–¨μ–΄μ§€μ§€ μ•λ‚μ”?

**A**: λ„¤, μ„±λ¥ μ €ν•κ°€ μμµλ‹λ‹¤. ν•μ§€λ§ **μ •ν™•μ„±**μ΄ λ” μ¤‘μ”ν• κ²½μ°κ°€ λ§μµλ‹λ‹¤. μ„±λ¥μ΄ μ¤‘μ”ν•λ‹¤λ©΄:
1. λ½μ λ²”μ„λ¥Ό μµμ†ν™” (λ©”μ„λ“ μ „μ²΄κ°€ μ•„λ‹ ν•„μ λ¶€λ¶„λ§)
2. waitTime/leaseTimeμ„ μ μ ν μ΅°μ •
3. λ©”μ‹μ§€ νλ΅ λΉ„λ™κΈ° μ²λ¦¬
4. μƒ¤λ”©μΌλ΅ λ½ κ²½ν•© λ¶„μ‚°

### Q5: μ—¬λ¬ μ„λ²„μ—μ„ λ™μ‹μ— κ°™μ€ μƒν’μ„ κµ¬λ§¤ν•λ©΄ μ–΄λ–»κ² λλ‚μ”?

**V1 (λ¬Έμ )**:
```
μ„λ²„ 1: μ¬κ³  100 μ½μ β†’ 99λ΅ μ—…λ°μ΄νΈ
μ„λ²„ 2: μ¬κ³  100 μ½μ β†’ 99λ΅ μ—…λ°μ΄νΈ
κ²°κ³Ό: μ¬κ³  99 (2λ…μ΄ κµ¬λ§¤ν–λ”λ°!)
```

**V2 (ν•΄κ²°)**:
```
μ„λ²„ 1: SELECT FOR UPDATE β†’ λ½ νλ“ β†’ 99λ΅ μ—…λ°μ΄νΈ β†’ μ»¤λ°‹
μ„λ²„ 2: SELECT FOR UPDATE β†’ λ€κΈ° β†’ 99 μ½μ β†’ 98λ΅ μ—…λ°μ΄νΈ β†’ μ»¤λ°‹
κ²°κ³Ό: μ¬κ³  98 β…
```

---

**λ¬Έμ„ μ‘μ„± μ™„λ£!** π‰

μ΄ λ¬Έμ„λ” λ™μ‹μ„± κ°λ…λ¶€ν„° μ‹¤μ  μ½”λ“ λ¶„μ„κΉμ§€ λ¨λ“  λ‚΄μ©μ„ λ‹¤λ£¨κ³  μμµλ‹λ‹¤. κ¶κΈν• μ μ΄ μμΌλ©΄ μ–Έμ λ“  μ§λ¬Έν•μ„Έμ”!
